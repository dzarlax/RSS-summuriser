{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="admin-container">
    {% include "admin/_sidebar.html" %}

    <div class="admin-main">
        <h1>–î–∞—à–±–æ—Ä–¥</h1>

        <!-- View toggles -->
        <div style="display:flex; gap:1rem; align-items:center; margin: 0 0 0.5rem 0; color: var(--text-muted);">
            <label class="form-label" style="display:flex; align-items:center; gap:.5rem;">
                <input type="checkbox" id="toggle-compact" onchange="toggleCompactStats()"> –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            </label>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="stat-card sources-card" data-tooltip="–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö RSS –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤">
                <div class="stat-icon">üì∞</div>
                <div class="stat-content">
                    <h3>–ò—Å—Ç–æ—á–Ω–∏–∫–∏</h3>
                    <div class="stat-number" id="sources-count">-</div>
                    <div class="stat-label">–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
                    <div class="stat-details" id="sources-details">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div class="stat-card articles-card" data-tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞">
                <div class="stat-icon">üìÑ</div>
                <div class="stat-content">
                    <h3>–°—Ç–∞—Ç—å–∏</h3>
                    <div class="stat-number" id="articles-count">-</div>
                    <div class="stat-label">–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24—á</div>
                    <div class="stat-details" id="articles-details">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div class="stat-card categories-card" data-tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–æ–≤–æ—Å—Ç–µ–π">
                <div class="stat-icon">üè∑Ô∏è</div>
                <div class="stat-content">
                    <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                    <div class="stat-number" id="categories-count">-</div>
                    <div class="stat-label">–∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–æ–≤–æ—Å—Ç–µ–π</div>
                    <div class="stat-details" id="categories-details">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div class="stat-card api-card" data-tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ API –≤—ã–∑–æ–≤–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è">
                <div class="stat-icon">‚ö°</div>
                <div class="stat-content">
                    <h3>API –≤—ã–∑–æ–≤—ã</h3>
                    <div class="stat-number" id="api-calls-count">-</div>
                    <div class="stat-label">—Å–µ–≥–æ–¥–Ω—è</div>
                    <div class="stat-details" id="api-details">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div class="stat-card errors-card" data-tooltip="–û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-content">
                    <h3>–û—à–∏–±–∫–∏</h3>
                    <div class="stat-number" id="errors-count">-</div>
                    <div class="stat-label">–∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                    <div class="stat-details" id="errors-details">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div class="stat-card performance-card" data-tooltip="–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞—Ç—å–∏">
                <div class="stat-icon">üöÄ</div>
                <div class="stat-content">
                    <h3>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
                    <div class="stat-number" id="performance-time">-</div>
                    <div class="stat-label">—Å–µ–∫/—Å—Ç–∞—Ç—å—è</div>
                    <div class="stat-details" id="performance-details">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <!-- Extraction efficiency card -->
            <div class="stat-card extractor-card" data-tooltip="–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Å–µ—Å—Å–∏—è)">
                <div class="stat-icon">üß©</div>
                <div class="stat-content">
                    <h3>–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ</h3>
                    <div class="stat-number" id="extractor-success">-</div>
                    <div class="stat-label">—É—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
                    <div class="stat-details" id="extractor-details">–ü–æ–ø—ã—Ç–æ–∫: -, –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã: -</div>
                </div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π -->
        <section class="dashboard-section control-panel" id="control-panel">
            <div class="dashboard-header">
                <h2>üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π</h2>
                <div class="last-sync" id="last-sync-info">
                    –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
            
            <div class="control-grid">
                <div class="control-card">
                    <div class="control-icon">üîÑ</div>
                    <div class="control-content">
                        <h3>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
                        <p>–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π</p>
                        <button id="sync-button" class="btn btn-primary" onclick="runManualSync()" data-tooltip="–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤">
                            <span class="sync-icon">üîÑ</span>
                            <span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                    </div>
                </div>
                
                <div class="control-card">
                    <div class="control-icon">üì±</div>
                    <div class="control-content">
                        <h3>Telegram</h3>
                        <p>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç –≤ –∫–∞–Ω–∞–ª</p>
                        <button id="telegram-button" class="btn btn-success" onclick="sendTelegramDigest()" data-tooltip="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ–¥–∫—É –≤ Telegram">
                            <span class="telegram-icon">üì±</span>
                            <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç</span>
                        </button>
                    </div>
                </div>
                
                <div class="control-card">
                    <div class="control-icon">üìä</div>
                    <div class="control-content">
                        <h3>–°–≤–æ–¥–∫–∏</h3>
                        <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–Ω–µ–≤–Ω—ã—Ö —Å–≤–æ–¥–æ–∫</p>
                        <button id="summaries-button" class="btn btn-info" onclick="generateSummaries()" data-tooltip="–°–æ–∑–¥–∞—Ç—å –¥–Ω–µ–≤–Ω—ã–µ —Å–≤–æ–¥–∫–∏">
                            <span>üìä</span>
                            <span>–°–æ–∑–¥–∞—Ç—å —Å–≤–æ–¥–∫–∏</span>
                        </button>
                    </div>
                </div>
                
                <div class="control-card">
                    <div class="control-icon">üßπ</div>
                    <div class="control-content">
                        <h3>–û—á–∏—Å—Ç–∫–∞</h3>
                        <p>–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ</p>
                        <button id="cleanup-button" class="btn btn-warning" onclick="cleanupOldData()" data-tooltip="–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ">
                            <span>üßπ</span>
                            <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="sync-status" class="sync-status" style="display: none;">
                <div class="sync-status-content">
                    <p id="sync-message">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
                    <div class="sync-progress">
                        <div class="sync-progress-bar"></div>
                    </div>
                </div>
            </div>
        </section>

        <div class="dashboard-sections">
            <section class="dashboard-section news-section" id="news-section">
                <div class="section-header">
                    <h2>üì∞ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏</h2>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="loadRecentNews()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                        <button class="btn btn-sm btn-ghost" onclick="toggleSection('news-section')" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñæ</button>
                    </div>
                </div>
                
                <div id="recent-news" class="recent-news-container section-body">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π...</p>
                    </div>
                </div>
                <div class="news-footer">
                    <a href="/admin/stats" class="link-button">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É ‚Üí</a>
                </div>
            </section>
            
            <section class="dashboard-section status-section" id="status-section">
                <div class="section-header">
                    <h2>‚ö° –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h2>
                    <div style="display:flex; gap:.5rem; align-items:center;">
                        <div class="status-timestamp" id="status-timestamp">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <button class="btn btn-sm btn-ghost" onclick="toggleSection('status-section')" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñæ</button>
                    </div>
                </div>
                <div class="section-body">
                <div class="system-status">
                    <div class="status-item" id="db-status">
                        <div class="status-indicator-wrapper">
                            <span class="status-indicator status-checking"></span>
                            <div class="status-pulse"></div>
                        </div>
                        <div class="status-content">
                            <span class="status-title">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</span>
                            <span class="status-details">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</span>
                        </div>
                    </div>
                    <div class="status-item" id="fs-status">
                        <div class="status-indicator-wrapper">
                            <span class="status-indicator status-checking"></span>
                            <div class="status-pulse"></div>
                        </div>
                        <div class="status-content">
                            <span class="status-title">–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</span>
                            <span class="status-details">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...</span>
                        </div>
                    </div>
                    <div class="status-item" id="processing-status">
                        <div class="status-indicator-wrapper">
                            <span class="status-indicator status-checking"></span>
                            <div class="status-pulse"></div>
                        </div>
                        <div class="status-content">
                            <span class="status-title">–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</span>
                            <span class="status-details">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...</span>
                        </div>
                    </div>
                    <div class="status-item" id="api-status">
                        <div class="status-indicator-wrapper">
                            <span class="status-indicator status-checking"></span>
                            <div class="status-pulse"></div>
                        </div>
                        <div class="status-content">
                            <span class="status-title">AI API</span>
                            <span class="status-details">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...</span>
                        </div>
                    </div>
                    <div class="status-item" id="telegram-status">
                        <div class="status-indicator-wrapper">
                            <span class="status-indicator status-checking"></span>
                            <div class="status-pulse"></div>
                        </div>
                        <div class="status-content">
                            <span class="status-title">Telegram –±–æ—Ç</span>
                            <span class="status-details">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</span>
                        </div>
                    </div>
                </div>
                <div class="status-footer">
                    <button class="btn btn-sm btn-outline" onclick="checkSystemStatus()">
                        üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                    </button>
                </div>
                </div>
            </section>
            
            <section class="dashboard-section queue-section section-collapsed" id="queue-section">
                <div class="section-header">
                    <h2>üöÄ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π –ë–î</h2>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="loadQueueStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                        <button class="btn btn-sm btn-ghost" onclick="toggleSection('queue-section')" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñæ</button>
                    </div>
                </div>
                <div class="section-body">
                <div class="queue-stats">
                    <div class="queue-stat-item" id="read-queue">
                        <div class="queue-indicator">
                            <span class="queue-type">–ß—Ç–µ–Ω–∏–µ</span>
                            <span class="queue-details" id="read-queue-details">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <div class="queue-metrics">
                            <span class="metric" id="read-operations">-</span>
                            <span class="metric-label">–æ–ø–µ—Ä–∞—Ü–∏–π</span>
                        </div>
                    </div>
                    <div class="queue-stat-item" id="write-queue">
                        <div class="queue-indicator">
                            <span class="queue-type">–ó–∞–ø–∏—Å—å</span>
                            <span class="queue-details" id="write-queue-details">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <div class="queue-metrics">
                            <span class="metric" id="write-operations">-</span>
                            <span class="metric-label">–æ–ø–µ—Ä–∞—Ü–∏–π</span>
                        </div>
                    </div>
                </div>
                <div class="queue-details-grid">
                    <div class="queue-detail">
                        <span class="label">–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏:</span>
                        <span class="value" id="total-queue-size">-</span>
                    </div>
                    <div class="queue-detail">
                        <span class="label">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:</span>
                        <span class="value" id="available-connections">-</span>
                    </div>
                    <div class="queue-detail">
                        <span class="label">–ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã:</span>
                        <span class="value" id="active-workers">-</span>
                    </div>
                    <div class="queue-detail">
                        <span class="label">–°—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏:</span>
                        <span class="value" id="queue-health">-</span>
                    </div>
                    <div class="queue-detail">
                        <span class="label">–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</span>
                        <span class="value" id="total-processed">-</span>
                    </div>
                    <div class="queue-detail">
                        <span class="label">–ü—É–ª –ë–î —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:</span>
                        <span class="value" id="db-pool-status">-</span>
                    </div>
                </div>
                </div>
            </section>

            <!-- Extraction per-domain section -->
            <section class="dashboard-section extractor-section section-collapsed" id="extractor-section">
                <div class="section-header">
                    <h2>üß† –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ: –¥–æ–º–µ–Ω—ã —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏</h2>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="loadExtractorStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                        <button class="btn btn-sm btn-ghost" onclick="toggleSection('extractor-section')" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñæ</button>
                    </div>
                </div>
                <div id="extractor-domains" class="recent-news-container section-body">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è...</p>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<style>
/* Dashboard-specific styles */
.dashboard-header {
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.last-sync {
    color: var(--text-muted);
    font-size: 0.9rem;
    background: var(--surface-hover);
    padding: 0.5rem 1rem;
    border-radius: var(--border-radius-sm);
}

/* Enhanced stats grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* Compact stats mode */
#stats-grid.stats-compact .stat-card { padding: 1rem; }
#stats-grid.stats-compact .stat-details { display: none; }

.stat-card {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.admin-main .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: auto;     /* –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º right –∏–∑ main.css */
    width: 3px;
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
    border-radius: 0 2px 2px 0;
    transform: none; /* —É–±–∏—Ä–∞–µ–º transform –∏–∑ main.css */
}

.stat-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.admin-main .stat-card:hover::before {
    width: 5px;
}

.stat-icon {
    font-size: 2.5rem;
    min-width: 60px;
    text-align: center;
    opacity: 0.8;
}

.stat-content {
    flex: 1;
}

.stat-content h3 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-color);
    margin: 0.25rem 0;
    line-height: 1;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.stat-details {
    font-size: 0.8rem;
    color: var(--text-muted);
    border-top: 1px solid var(--border-color);
    padding-top: 0.5rem;
    margin-top: 0.5rem;
}

/* Specific card colors */
.sources-card::before { background: #3b82f6; }
.articles-card::before { background: #10b981; }
.categories-card::before { background: #f59e0b; }
.api-card::before { background: #8b5cf6; }
.errors-card::before { background: #ef4444; }
.performance-card::before { background: #06b6d4; }

/* Control panel */
.control-panel {
    background: linear-gradient(135deg, var(--surface-color) 0%, var(--surface-hover) 100%);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
}

.control-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.control-card {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
}

.control-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.control-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.8;
}

.control-content h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    color: var(--text-color);
}

.control-content p {
    margin: 0 0 1rem 0;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.control-content .btn {
    width: 100%;
    justify-content: center;
}

.sync-status {
    background: var(--surface-hover);
    padding: 1.5rem;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--border-color);
    margin-top: 1rem;
}

.sync-status-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.sync-progress {
    width: 100%;
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
}

.sync-progress-bar {
    height: 100%;
    background: var(--gradient-primary);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

.sync-btn {
    position: relative;
    overflow: hidden;
}

.sync-btn .sync-icon {
    transition: transform 0.3s ease;
}

.sync-btn.syncing .sync-icon {
    animation: spin 1s linear infinite;
}

.telegram-btn .telegram-icon {
    transition: transform 0.2s ease;
}

.telegram-btn:hover .telegram-icon {
    transform: scale(1.2);
}

/* Dashboard sections */
.dashboard-sections {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 2rem;
    margin-top: 2rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.section-body { margin-top: 0.5rem; }
.section-collapsed .section-body { display: none; }

.section-header h2 {
    margin: 0;
    font-size: 1.25rem;
}

/* Recent news section */
.news-section {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
}

.recent-news-container {
    min-height: 300px;
}

.loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: var(--text-muted);
}

.spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.news-item {
    background: var(--surface-hover);
    padding: 1rem;
    border-radius: var(--border-radius-sm);
    margin-bottom: 0.75rem;
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
    position: relative;
}

.news-item:hover {
    background: var(--surface-color);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.news-item:last-child {
    margin-bottom: 0;
}

.news-item h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    line-height: 1.4;
}

.news-item h4 a {
    color: var(--text-color);
    text-decoration: none;
    transition: color 0.2s ease;
}

.news-item h4 a:hover {
    color: var(--primary-color);
    text-decoration: underline;
}

.news-item .news-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-top: 0.5rem;
}

.news-category {
    background: var(--primary-color);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 500;
}

.news-footer {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
    text-align: center;
}

.link-button {
    color: var(--primary-color);
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.2s ease;
}

.link-button:hover {
    text-decoration: underline;
}

/* Status section */
.status-section {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    height: fit-content;
}

.status-timestamp {
    font-size: 0.8rem;
    color: var(--text-muted);
    background: var(--surface-hover);
    padding: 0.25rem 0.75rem;
    border-radius: var(--border-radius-sm);
}

.system-status {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--surface-hover);
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
}

.status-item:hover {
    box-shadow: var(--shadow-sm);
}

.status-indicator-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    position: relative;
    z-index: 2;
}

.status-pulse {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    opacity: 0;
    z-index: 1;
}

.status-checking {
    background: #fbbf24;
}

.status-checking + .status-pulse {
    background: #fbbf24;
    animation: pulse 2s infinite;
}

.status-ok {
    background: #10b981;
}

.status-ok + .status-pulse {
    background: #10b981;
    animation: pulse-success 3s infinite;
}

.status-error {
    background: #ef4444;
}

.status-error + .status-pulse {
    background: #ef4444;
    animation: pulse-error 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(0.8); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.3; }
    100% { transform: scale(0.8); opacity: 1; }
}

@keyframes pulse-success {
    0%, 90% { transform: scale(0.8); opacity: 0; }
    95% { transform: scale(1.2); opacity: 0.5; }
    100% { transform: scale(0.8); opacity: 0; }
}

@keyframes pulse-error {
    0% { transform: scale(0.8); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.5; }
    100% { transform: scale(0.8); opacity: 1; }
}

.status-content {
    flex: 1;
}

.status-title {
    display: block;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.25rem;
}

.status-details {
    display: block;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.status-footer {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
    text-align: center;
}

/* Notification system */
.notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
}

.notification {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-lg);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    overflow: hidden;
}

.notification-show {
    transform: translateX(0);
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
}

.notification-icon {
    font-size: 1.2rem;
    min-width: 20px;
}

.notification-message {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text-color);
}

.notification-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0;
    min-width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.notification-close:hover {
    color: var(--text-color);
}

.notification-success {
    border-left: 4px solid #10b981;
}

.notification-error {
    border-left: 4px solid #ef4444;
}

.notification-warning {
    border-left: 4px solid #f59e0b;
}

.notification-info {
    border-left: 4px solid #3b82f6;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .dashboard-sections {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
}

@media (max-width: 768px) {
    .admin-container {
        flex-direction: column;
    }
    
    .admin-sidebar {
        width: 100%;
        order: 2;
    }
    
    .admin-main {
        order: 1;
    }
    
    .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .stat-card {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .stat-icon {
        font-size: 3rem;
    }
    
    .control-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .dashboard-sections {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .notification-container {
        left: 10px;
        right: 10px;
        max-width: none;
    }
}

@media (max-width: 480px) {
    .control-panel {
        padding: 1rem;
    }
    
    .news-section,
    .status-section {
        padding: 1rem;
    }
    
    .stat-card {
        padding: 1rem;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .control-card {
        padding: 1rem;
    }
}

/* Queue Statistics Styles */
.queue-section {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
}

.queue-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.queue-stat-item {
    background: var(--surface-hover);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.queue-indicator .queue-type {
    font-weight: 600;
    color: var(--text-color);
    display: block;
    margin-bottom: 0.25rem;
}

.queue-indicator .queue-details {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.queue-metrics {
    text-align: right;
}

.queue-metrics .metric {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    display: block;
}

.queue-metrics .metric-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.queue-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.queue-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color);
}

.queue-detail .label {
    font-size: 0.9rem;
    color: var(--text-muted);
}

.queue-detail .value {
    font-weight: 600;
    color: var(--text-color);
}

.queue-detail .value small {
    font-weight: 400;
    color: var(--text-muted);
    font-size: 0.8em;
}

#queue-health {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

#db-pool-status {
    font-family: monospace;
    font-size: 0.8em;
    background: var(--surface-hover);
    padding: 0.2rem 0.4rem;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--border-color);
}

@media (max-width: 768px) {
    .queue-stats {
        grid-template-columns: 1fr;
    }
    
    .queue-details-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Local API request function for dashboard
async function apiRequest(url, options = {}) {
    try {
        const response = await fetch(url, {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('API request failed:', error);
        throw error;
    }
}

// Animation function for numbers
function animateNumber(element, targetValue) {
    const startValue = parseInt(element.textContent) || 0;
    const duration = 1000; // 1 second
    const startTime = Date.now();
    
    function updateNumber() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth animation
        const easeOutQuart = 1 - Math.pow(1 - progress, 4);
        const currentValue = Math.round(startValue + (targetValue - startValue) * easeOutQuart);
        
        element.textContent = currentValue;
        
        if (progress < 1) {
            requestAnimationFrame(updateNumber);
        }
    }
    
    requestAnimationFrame(updateNumber);
}

// Show notification function
function showNotification(message, type = 'info') {
    console.log(`${type.toUpperCase()}: ${message}`);
    // For now, just log. Could be enhanced later.
}

// Compact stats toggle
function toggleCompactStats() {
    const grid = document.getElementById('stats-grid');
    const cb = document.getElementById('toggle-compact');
    if (!grid || !cb) return;
    if (cb.checked) {
        grid.classList.add('stats-compact');
        localStorage.setItem('dash_stats_compact', '1');
    } else {
        grid.classList.remove('stats-compact');
        localStorage.removeItem('dash_stats_compact');
    }
}

// Section collapse/expand with persistence
function toggleSection(sectionId) {
    const sec = document.getElementById(sectionId);
    if (!sec) return;
    sec.classList.toggle('section-collapsed');
    const collapsed = sec.classList.contains('section-collapsed');
    localStorage.setItem('dash_collapse_' + sectionId, collapsed ? '1' : '0');
}

// Restore UI state
document.addEventListener('DOMContentLoaded', () => {
    const compact = localStorage.getItem('dash_stats_compact') === '1';
    const cb = document.getElementById('toggle-compact');
    if (cb) cb.checked = compact;
    if (compact) {
        const grid = document.getElementById('stats-grid');
        if (grid) grid.classList.add('stats-compact');
    }

    ['news-section', 'status-section', 'queue-section', 'extractor-section'].forEach(id => {
        const val = localStorage.getItem('dash_collapse_' + id);
        const sec = document.getElementById(id);
        if (sec && val === '1') {
            sec.classList.add('section-collapsed');
        }
    });
}, { once: true });

document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    checkSystemStatus();
    
    // Auto-refresh dashboard data every 30 seconds
    setInterval(loadDashboardData, 30000);
    
    // Check system status every 60 seconds
    setInterval(checkSystemStatus, 60000);
});

async function loadDashboardData() {
    try {
        const response = await apiRequest('/api/v1/stats/dashboard');
        
        // Animate stats numbers and update details
        if (response.active_sources !== undefined) {
            animateNumber(
                document.getElementById('sources-count'), 
                response.active_sources
            );
            document.getElementById('sources-details').textContent = 
                `${response.total_sources || 0} –≤—Å–µ–≥–æ, ${response.disabled_sources || 0} –æ—Ç–∫–ª—é—á–µ–Ω–æ`;
        }
        
        if (response.today_articles !== undefined) {
            animateNumber(
                document.getElementById('articles-count'), 
                response.today_articles
            );
            document.getElementById('articles-details').textContent = 
                `${response.total_articles || 0} –≤—Å–µ–≥–æ, ${response.processed_today || 0} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ`;
        }
        
        if (response.categories_count !== undefined) {
            animateNumber(
                document.getElementById('categories-count'), 
                response.categories_count
            );
            document.getElementById('categories-details').textContent = 
                `${response.top_category || 'N/A'} ‚Äî —Å–∞–º–∞—è –ø–æ–ø—É–ª—è—Ä–Ω–∞—è`;
        }
        
        if (response.api_calls_today !== undefined) {
            animateNumber(
                document.getElementById('api-calls-count'), 
                response.api_calls_today
            );
            document.getElementById('api-details').textContent = 
                `${response.api_success_rate || 0}% —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤`;
        }
        
        // New stats
        if (response.errors_today !== undefined) {
            animateNumber(
                document.getElementById('errors-count'), 
                response.errors_today
            );
            document.getElementById('errors-details').textContent = 
                response.errors_today > 0 ? `–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è` : `–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ`;
        }
        
        if (response.avg_processing_time !== undefined) {
            document.getElementById('performance-time').textContent = 
                (response.avg_processing_time / 1000).toFixed(1);
            document.getElementById('performance-details').textContent = 
                `${response.articles_per_hour || 0} —Å—Ç–∞—Ç–µ–π/—á–∞—Å`;
        }
        
        // Update last sync info
        if (response.last_sync) {
            document.getElementById('last-sync-info').textContent = 
                `–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ${new Date(response.last_sync).toLocaleString('ru-RU')}`;
        }
        
        // Load recent news
        loadRecentNews();

        // Load extractor high-level stats and per-domain details
        loadExtractorStats();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞', 'error');
    }
}

async function loadRecentNews() {
    const newsContainer = document.getElementById('recent-news');
    
    try {
        newsContainer.innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π...</p>
            </div>
        `;
        
        const response = await apiRequest('/api/v1/feed?limit=6');
        
        if (response.items && response.items.length > 0) {
            const newsHtml = response.items.map(item => `
                <div class="news-item">
                    <h4><a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.title}</a></h4>
                    <div class="news-meta">
                        <span>${item.domain} ‚Ä¢ ${new Date(item.published_at).toLocaleString('ru-RU')}</span>
                        ${item.category ? `<span class="news-category">${item.category}</span>` : ''}
                    </div>
                </div>
            `).join('');
            
            newsContainer.innerHTML = newsHtml;
        } else {
            newsContainer.innerHTML = `
                <div class="loading-state">
                    <p style="margin: 0;">üì∞ –ù–µ—Ç –Ω–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading recent news:', error);
        newsContainer.innerHTML = `
            <div class="loading-state">
                <p style="margin: 0; color: var(--error-color);">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π</p>
            </div>
        `;
    }
}

async function checkSystemStatus() {
    const timestamp = document.getElementById('status-timestamp');
    timestamp.textContent = `–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${new Date().toLocaleString('ru-RU')}`;
    
    // Check database
    await checkService('db-status', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö', async () => {
        const response = await apiRequest('/api/v1/stats/dashboard');
        return response ? { status: 'ok', message: '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ' } : null;
    });
    
    // Check filesystem
    await checkService('fs-status', '–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞', async () => {
        // Simple check - if we can make API calls, filesystem is probably ok
        return { status: 'ok', message: '–î–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏' };
    });
    
    // Check processing
    await checkService('processing-status', '–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π', async () => {
        const response = await apiRequest('/api/v1/sources');
        return response ? { status: 'ok', message: '–°–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç' } : null;
    });
    
    // Check AI API
    await checkService('api-status', 'AI API', async () => {
        // This would need a specific health check endpoint
        return { status: 'ok', message: '–°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω' };
    });
    
    // Check Telegram
    await checkService('telegram-status', 'Telegram –±–æ—Ç', async () => {
        // This would need a specific health check endpoint
        return { status: 'ok', message: '–ë–æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω' };
    });
}

async function checkService(elementId, serviceName, checkFunction) {
    const element = document.getElementById(elementId);
    const indicator = element.querySelector('.status-indicator');
    const details = element.querySelector('.status-details');
    
    // Set checking state
    indicator.className = 'status-indicator status-checking';
    details.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
    
    try {
        const result = await checkFunction();
        
        if (result && result.status === 'ok') {
            indicator.className = 'status-indicator status-ok';
            details.textContent = result.message;
        } else {
            indicator.className = 'status-indicator status-error';
            details.textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
        }
    } catch (error) {
        console.error(`Error checking ${serviceName}:`, error);
        indicator.className = 'status-indicator status-error';
        details.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
    }
}

async function runManualSync() {
    const button = document.getElementById('sync-button');
    const statusDiv = document.getElementById('sync-status');
    const messageEl = document.getElementById('sync-message');
    const progressBar = document.querySelector('.sync-progress-bar');
    
    // Show sync status
    statusDiv.style.display = 'block';
    button.classList.add('btn-loading');
    button.disabled = true;
    
    try {
        messageEl.textContent = '–ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...';
        progressBar.style.width = '10%';
        
        const response = await apiRequest('/api/v1/process/run', {
            method: 'POST'
        });
        
        if (response.success) {
            messageEl.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!';
            progressBar.style.width = '100%';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
                loadDashboardData(); // Refresh stats
            }, 2000);
            
            showNotification('–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –∑–∞–ø—É—â–µ–Ω–∞', 'success');
        } else {
            throw new Error(response.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏');
        }
        
    } catch (error) {
        console.error('Error starting sync:', error);
        messageEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏';
        statusDiv.style.display = 'none';
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
    } finally {
        button.classList.remove('btn-loading');
        button.disabled = false;
    }
}

async function sendTelegramDigest() {
    const button = document.getElementById('telegram-button');
    
    button.classList.add('btn-loading');
    button.disabled = true;
    
    try {
        const response = await apiRequest('/api/v1/telegram/send-digest', {
            method: 'POST'
        });
        
        if (response.success) {
            showNotification('–î–∞–π–¥–∂–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram', 'success');
        } else {
            throw new Error(response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
    } catch (error) {
        console.error('Error sending telegram digest:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram', 'error');
    } finally {
        button.classList.remove('btn-loading');
        button.disabled = false;
    }
}

async function generateSummaries() {
    const button = document.getElementById('summaries-button');
    
    button.classList.add('btn-loading');
    button.disabled = true;
    
    try {
        const response = await apiRequest('/api/v1/summaries/generate', {
            method: 'POST'
        });
        
        if (response.success) {
            showNotification('–î–Ω–µ–≤–Ω—ã–µ —Å–≤–æ–¥–∫–∏ —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
            loadDashboardData(); // Refresh stats
        } else {
            throw new Error(response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
    } catch (error) {
        console.error('Error generating summaries:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–æ–¥–æ–∫', 'error');
    } finally {
        button.classList.remove('btn-loading');
        button.disabled = false;
    }
}

async function cleanupOldData() {
    const button = document.getElementById('cleanup-button');
    
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    button.classList.add('btn-loading');
    button.disabled = true;
    
    try {
        const response = await apiRequest('/api/v1/admin/cleanup', {
            method: 'POST',
            body: JSON.stringify({
                days_to_keep: 30
            })
        });
        
        if (response.success) {
            showNotification(`–û—á–∏—â–µ–Ω–æ: ${response.deleted_articles || 0} —Å—Ç–∞—Ç–µ–π, ${response.deleted_logs || 0} –ª–æ–≥–æ–≤`, 'success');
            loadDashboardData(); // Refresh stats
        } else {
            throw new Error(response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
    } catch (error) {
        console.error('Error cleaning up data:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
    } finally {
        button.classList.remove('btn-loading');
        button.disabled = false;
    }
}

// Enhanced notification system
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">${getNotificationIcon(type)}</span>
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
    `;
    
    // Add to page
    let container = document.querySelector('.notification-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'notification-container';
        document.body.appendChild(container);
    }
    
    container.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
    
    // Add slide-in animation
    setTimeout(() => {
        notification.classList.add('notification-show');
    }, 10);
}

function getNotificationIcon(type) {
    switch (type) {
        case 'success': return '‚úÖ';
        case 'error': return '‚ùå';
        case 'warning': return '‚ö†Ô∏è';
        default: return '‚ÑπÔ∏è';
    }
}

async function loadQueueStats() {
    try {
        const response = await apiRequest('/api/v1/stats/queue');
        
        if (response.success && response.stats) {
            const stats = response.stats;
            
            // Update read queue stats
            document.getElementById('read-operations').textContent = stats.read_operations || 0;
            document.getElementById('read-queue-details').textContent = 
                `–û—á–µ—Ä–µ–¥—å: ${stats.read_queue_size || 0}, –û—à–∏–±–æ–∫: ${stats.read_errors || 0}`;
            
            // Update write queue stats  
            document.getElementById('write-operations').textContent = stats.write_operations || 0;
            document.getElementById('write-queue-details').textContent = 
                `–û—á–µ—Ä–µ–¥—å: ${stats.write_queue_size || 0}, –û—à–∏–±–æ–∫: ${stats.write_errors || 0}`;
            
            // Update summary stats
            document.getElementById('total-queue-size').textContent = 
                `${(stats.read_queue_size || 0) + (stats.write_queue_size || 0)}`;
            document.getElementById('available-connections').textContent = 
                `–ß: ${stats.read_connections_available || 0}, –ó: ${stats.write_connections_available || 0}`;
            document.getElementById('active-workers').textContent = 
                `${stats.active_workers || 0}/${stats.expected_workers || 0}`;
            
            // Queue health status with visual indicator
            const healthStatus = stats.healthy ? 'üü¢ –ó–¥–æ—Ä–æ–≤–∞' : 'üî¥ –ü—Ä–æ–±–ª–µ–º—ã';
            const healthDetails = stats.running ? '—Ä–∞–±–æ—Ç–∞–µ—Ç' : '–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
            document.getElementById('queue-health').innerHTML = 
                `${healthStatus} <small>(${healthDetails})</small>`;
                
            document.getElementById('total-processed').textContent = 
                `${stats.total_processed || 0}`;
                
            // Database pool status  
            document.getElementById('db-pool-status').textContent = 
                stats.db_pool_status || '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                
        } else {
            // Show error state
            document.getElementById('read-queue-details').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            document.getElementById('write-queue-details').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }
        
    } catch (error) {
        console.error('Error loading queue stats:', error);
        document.getElementById('read-queue-details').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
        document.getElementById('write-queue-details').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
    }
}

// Load queue stats when page loads and add to dashboard data loading
document.addEventListener('DOMContentLoaded', function() {
    loadQueueStats();
    // Auto-refresh every 30 seconds
    setInterval(loadQueueStats, 30000);
});

async function loadExtractorStats() {
    try {
        const response = await apiRequest('/api/v1/stats/extractor');
        if (response.success && response.overall) {
            const overall = response.overall;
            // Overall success
            const successRate = Math.round(overall.success_rate || 0);
            document.getElementById('extractor-success').textContent = `${successRate}%`;
            document.getElementById('extractor-details').textContent = 
                `–ü–æ–ø—ã—Ç–æ–∫: ${overall.total_attempts || 0}, –®–∞–±–ª–æ–Ω–æ–≤: ${overall.patterns_discovered || 0}`;
        }
        // Domains table (top problem domains)
        const container = document.getElementById('extractor-domains');
        const domains = (response.domains || []).slice(0, 10);
        if (domains.length === 0) {
            container.innerHTML = `<div class="loading-state"><p style="margin:0;">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p></div>`;
            return;
        }
        const rows = domains.map(d => {
            const rate = Math.round(d.success_rate || 0);
            const methods = Object.entries(d.methods || {})
                .map(([name, val]) => `${name}: ${val.successes||0}/${val.attempts||0}`)
                .join(', ');
            return `
                <div class="news-item">
                    <h4>${d.domain}</h4>
                    <div class="news-meta">
                        <span>–ü–æ–ø—ã—Ç–æ–∫: ${d.total_attempts} ‚Ä¢ –£—Å–ø–µ—Ö: ${rate}%</span>
                        <span class="news-category">${methods || '‚Äî'}</span>
                    </div>
                </div>
            `;
        }).join('');
        container.innerHTML = rows;
    } catch (error) {
        console.error('Error loading extractor stats:', error);
        document.getElementById('extractor-domains').innerHTML = `
            <div class="loading-state"><p style="margin:0;color:var(--error-color);">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>
        `;
    }
}
</script>
{% endblock %}
