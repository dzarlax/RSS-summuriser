{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--surface, #ffffff);
    border-radius: 8px;
    padding: 0;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border, #e0e0e0);
}

.modal-content form {
    padding: 1rem;
}

.modal-actions {
    border-top: 1px solid var(--border, #e0e0e0);
    padding: 1rem;
    margin: 0 !important;
}
</style>

<div class="admin-container">
    {% include "admin/_sidebar.html" %}

    <div class="admin-main">
        <h1>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –º–∞–ø–ø–∏–Ω–≥–∏</h1>
        <p style="color: var(--text-muted); margin-bottom: 1rem;">–°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–æ–º AI –∫–∞—Ç–µ–≥–æ—Ä–∏–π</p>

        <!-- Tabs -->
        <div class="tabs" style="display:flex; gap:.5rem; margin-bottom:1rem;">
            <button id="tab-btn-categories" class="btn btn-ghost" onclick="switchTab('categories')">–û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
            <button id="tab-btn-mappings" class="btn btn-ghost" onclick="switchTab('mappings')">–ú–∞–ø–ø–∏–Ω–≥–∏</button>
        </div>

        <!-- Statistics (Mappings tab) -->
        <div class="stats-grid" id="stats-section">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <h3>–í—Å–µ–≥–æ –º–∞–ø–ø–∏–Ω–≥–æ–≤</h3>
                    <div class="stat-number" id="total-mappings">-</div>
                    <div class="stat-label">–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö</h3>
                    <div class="stat-number" id="active-mappings">-</div>
                    <div class="stat-label">—Ä–∞–±–æ—Ç–∞—é—â–∏—Ö</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üîÑ</div>
                <div class="stat-content">
                    <h3>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</h3>
                    <div class="stat-number" id="total-usage">-</div>
                    <div class="stat-label">–≤—Å–µ–≥–æ —Ä–∞–∑</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè∑Ô∏è</div>
                <div class="stat-content">
                    <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–π</h3>
                    <div class="stat-number" id="fixed-categories">-</div>
                    <div class="stat-label">–≤ –±–∞–∑–µ</div>
                </div>
            </div>
        </div>

        <!-- Alert container -->
        <div id="alert-container" style="margin-bottom: 1rem;"></div>

        

        <!-- Main Categories Admin (Categories tab) -->
        <div class="dashboard-section" id="categories-admin-section">
            <div class="section-header">
                <h2>üè∑Ô∏è –û—Å–Ω–æ–≤–Ω—ã–µ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
            </div>

            <div class="cards-grid" style="grid-template-columns: 1fr 2fr;">
                <div class="card" style="padding: 1rem;">
                    <h3 style="margin-top: 0;">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
                    <form id="category-form">
                        <div class="form-group">
                            <label class="form-label" for="cat-name">–°–∏—Å—Ç–µ–º–Ω–æ–µ –∏–º—è (EN)</label>
                            <input type="text" id="cat-name" name="name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Business" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="cat-display">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                            <input type="text" id="cat-display" name="display_name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∏–∑–Ω–µ—Å" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="cat-color">–¶–≤–µ—Ç</label>
                            <input type="color" id="cat-color" name="color" value="#6c757d" class="form-input" style="height: 40px; padding: 0;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="cat-desc">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <textarea id="cat-desc" name="description" class="form-input" style="height: 60px; resize: vertical;" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"></textarea>
                        </div>
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </form>
                </div>

                <div class="card" style="padding: 1rem;">
                    <h3 style="margin-top: 0;">–°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>–ò–º—è</th>
                                    <th>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ</th>
                                    <th>–¶–≤–µ—Ç</th>
                                    <th>–°—Ç–∞—Ç–µ–π</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="categories-tbody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 1rem; color: var(--text-muted);">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Category Modal -->
        <div id="edit-category-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 style="margin: 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
                    <button class="btn btn-ghost" onclick="closeEditModal()" style="padding: 0.5rem;">‚úï</button>
                </div>
                <form id="edit-category-form">
                    <input type="hidden" id="edit-cat-id" name="category_id">
                    <div class="form-group">
                        <label class="form-label" for="edit-cat-name">–°–∏—Å—Ç–µ–º–Ω–æ–µ –∏–º—è (EN)</label>
                        <input type="text" id="edit-cat-name" name="name" required class="form-input" readonly style="background: var(--surface-hover); color: var(--text-muted);">
                        <small style="color: var(--text-muted);">–°–∏—Å—Ç–µ–º–Ω–æ–µ –∏–º—è –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-cat-display">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                        <input type="text" id="edit-cat-display" name="display_name" required class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-cat-color">–¶–≤–µ—Ç</label>
                        <input type="color" id="edit-cat-color" name="color" class="form-input" style="height: 40px; padding: 0;">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-cat-desc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="edit-cat-desc" name="description" class="form-input" style="height: 60px; resize: vertical;"></textarea>
                    </div>
                    <div class="modal-actions" style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Mappings Table (Mappings tab) -->
        <div class="dashboard-section" id="mappings-section">
            <div class="section-header">
                <h2>üè∑Ô∏è –ú–∞–ø–ø–∏–Ω–≥ –ö–∞—Ç–µ–≥–æ—Ä–∏–π</h2>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="text" id="mapping-search" class="form-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ AI –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" style="width:220px;" oninput="renderMappings()">
                    <label class="form-label" style="display:flex; align-items:center; gap:.25rem;">
                        <input type="checkbox" id="mapping-active-only" checked onchange="renderMappings()"> –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
                    </label>
                    <button id="unmapped-toggle-btn" class="btn btn-info" onclick="toggleUnmappedSection()">üîç –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ</button>
                    <button class="btn btn-success" onclick="openCreateModal()">+ –î–æ–±–∞–≤–∏—Ç—å –ú–∞–ø–ø–∏–Ω–≥</button>
                </div>
            </div>
            
            <!-- Collapsible Unmapped section appears directly under the toggle button -->
            <div class="dashboard-section" id="unmapped-section" style="display: none;">
                <div class="section-header">
                    <h2>üîç –ù–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ AI –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
                    <button class="btn btn-secondary" onclick="toggleUnmappedSection()">–°–∫—Ä—ã—Ç—å</button>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>AI –ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</th>
                                <th>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="unmapped-tbody">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    <div class="loading-state">
                                        <div class="spinner"></div>
                                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>AI –ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</th>
                            <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="mappings-tbody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                <div class="loading-state">
                                    <div class="spinner"></div>
                                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–ø–ø–∏–Ω–≥–æ–≤...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Create/Edit Modal -->
<div id="mapping-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--surface-color); border-radius: var(--border-radius-lg); padding: 2rem; width: 90%; max-width: 500px; box-shadow: var(--shadow-xl); border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
            <h3 id="modal-title" style="margin: 0; color: var(--text-color); font-size: 1.25rem;">–î–æ–±–∞–≤–∏—Ç—å –ú–∞–ø–ø–∏–Ω–≥</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius-sm);" onmouseover="this.style.background='var(--surface-hover)'" onmouseout="this.style.background='none'">&times;</button>
        </div>
        
        <form id="mapping-form">
            <div class="form-group">
                <label class="form-label" for="ai-category">AI –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <input type="text" id="ai-category" name="ai_category" required 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Russia, Health, Events"
                       class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="fixed-category">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="fixed-category" name="fixed_category" required class="form-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="confidence-threshold">–ü–æ—Ä–æ–≥ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</label>
                <input type="number" id="confidence-threshold" name="confidence_threshold" 
                       min="0" max="1" step="0.1" value="0.0"
                       class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <textarea id="description" name="description" 
                          placeholder="–ü–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ç–æ—Ç –º–∞–ø–ø–∏–Ω–≥..."
                          class="form-input" style="height: 60px; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<script>
let mappings = [];
let fixedCategories = [];
let unmappedCategories = [];
let editingId = null;
let currentTab = 'mappings';

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    const saved = localStorage.getItem('categories_tab');
    currentTab = saved === 'categories' ? 'categories' : 'mappings';
    switchTab(currentTab);

    loadFixedCategories();
    loadMappings();
    loadUnmappedCategories();
    loadCategoriesList();
});

function getCategoryBadgeClass(category) {
    const map = {
        'Serbia': 'category-serbia',
        'Tech': 'category-tech', 
        'Business': 'category-business',
        'Science': 'category-science',
        'Politics': 'category-politics',
        'International': 'category-international',
        'Other': 'category-other'
    };
    return map[category] || 'category-other';
}

function formatDate(dateString) {
    if (!dateString) return '–ù–∏–∫–æ–≥–¥–∞';
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU');
}

function showAlert(message, type = 'success') {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    
    // Use the design system's notification styles
    const bgColors = {
        'success': '#d1fae5',
        'error': '#fee2e2', 
        'warning': '#fef3c7',
        'info': '#dbeafe'
    };
    const textColors = {
        'success': '#065f46',
        'error': '#dc2626',
        'warning': '#92400e',
        'info': '#1e40af'
    };
    const borderColors = {
        'success': '#a7f3d0',
        'error': '#fca5a5',
        'warning': '#fde68a',
        'info': '#bfdbfe'
    };
    
    alert.style.cssText = `
        background: ${bgColors[type] || bgColors.info};
        color: ${textColors[type] || textColors.info};
        border: 1px solid ${borderColors[type] || borderColors.info};
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    `;
    
    const icons = {
        'success': '‚úÖ',
        'error': '‚ùå', 
        'warning': '‚ö†Ô∏è',
        'info': '‚ÑπÔ∏è'
    };
    
    alert.innerHTML = `
        <span>${icons[type] || icons.info}</span>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2rem; padding: 0.25rem;">√ó</button>
    `;
    
    container.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}

async function loadFixedCategories() {
    try {
        const response = await fetch('/api/v1/category-mappings/fixed-categories');
        const data = await response.json();
        fixedCategories = data.categories;
        
        const select = document.getElementById('fixed-category');
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>';
        fixedCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.key;
            option.textContent = cat.display_name;
            select.appendChild(option);
        });

        const fixedCount = document.getElementById('fixed-categories');
        if (fixedCount) fixedCount.textContent = fixedCategories.length;
    } catch (error) {
        console.error('Failed to load fixed categories:', error);
    }
}

async function loadCategoriesList() {
    try {
        const response = await fetch('/api/v1/categories');
        const data = await response.json();
        const tbody = document.getElementById('categories-tbody');

        if (!data.categories || data.categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--text-muted);">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç</td></tr>';
            return;
        }

        tbody.innerHTML = data.categories.map(c => `
            <tr>
                <td><code>${c.category}</code></td>
                <td>${c.display_name || ''}</td>
                <td>
                    <span style="display:inline-block; width:16px; height:16px; border-radius:3px; background:${c.color || '#6c757d'}; vertical-align:middle; margin-right:6px;"></span>
                    <span style="color: var(--text-muted);">${c.color || ''}</span>
                </td>
                <td><span class="badge badge-info" style="background: var(--surface-hover); color: var(--text-muted);">${c.count}</span></td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="openEditModal('${c.category}', '${(c.display_name || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;')}', '${c.color || '#6c757d'}', '${(c.description || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;')}', ${c.id})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                        ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Failed to load categories list:', error);
    }
}

async function loadMappings() {
    try {
        const response = await fetch('/api/v1/category-mappings?active_only=false');
        const data = await response.json();
        mappings = data;
        
        renderMappings();
        updateStats();
    } catch (error) {
        console.error('Failed to load mappings:', error);
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–ø–ø–∏–Ω–≥–æ–≤', 'error');
    }
}

async function loadUnmappedCategories() {
    try {
        const response = await fetch('/api/v1/category-mappings/unmapped');
        const data = await response.json();
        unmappedCategories = data.unmapped_categories || [];
        
        // Update button text with count
        const button = document.getElementById('unmapped-toggle-btn');
        if (button && button.textContent.includes('–ü–æ–∫–∞–∑–∞—Ç—å')) {
            button.textContent = `üîç –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ (${unmappedCategories.length})`;
        }
        
    } catch (error) {
        console.error('Failed to load unmapped categories:', error);
    }
}

function renderMappings() {
    const tbody = document.getElementById('mappings-tbody');
    if (!tbody) return;

    const q = (document.getElementById('mapping-search')?.value || '').toLowerCase();
    const activeOnly = document.getElementById('mapping-active-only')?.checked;

    const filtered = mappings.filter(m => {
        const matches = !q || m.ai_category.toLowerCase().includes(q);
        const activeOk = !activeOnly || m.is_active;
        return matches && activeOk;
    });

    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                        <span style="font-size: 2rem;">üìÑ</span>
                        <p style="margin: 0;">–ú–∞–ø–ø–∏–Ω–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filtered.map(mapping => `
        <tr style="${!mapping.is_active ? 'opacity: 0.6; background: var(--surface-hover);' : ''}">
            <td><strong style="color: var(--text-color);">${mapping.ai_category}</strong></td>
            <td>
                <span class="category-badge ${getCategoryBadgeClass(mapping.fixed_category)}">
                    ${mapping.fixed_category}
                </span>
            </td>
            <td>
                <span class="badge badge-info" style="background: var(--surface-hover); color: var(--text-muted); padding: 0.25rem 0.5rem; border-radius: var(--border-radius-sm); font-size: 0.75rem;">
                    ${mapping.usage_count}
                </span>
            </td>
            <td style="color: var(--text-muted); font-size: 0.875rem;">${formatDate(mapping.last_used)}</td>
            <td>
                <span class="status-badge ${mapping.is_active ? 'status-active' : 'status-inactive'}">
                    ${mapping.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                </span>
            </td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-small" onclick="editMapping(${mapping.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥" data-tooltip="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" style="background: var(--primary-color); color: white;">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn btn-small" onclick="toggleMapping(${mapping.id})" title="${mapping.is_active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}" data-tooltip="${mapping.is_active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}" style="background: var(--secondary-color); color: white;">
                        ${mapping.is_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                    </button>
                    <button class="btn btn-small" onclick="deleteMapping(${mapping.id})" title="–£–¥–∞–ª–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥" data-tooltip="–£–¥–∞–ª–∏—Ç—å" style="background: var(--danger-color); color: white;">
                        üóëÔ∏è
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function updateStats() {
    document.getElementById('total-mappings').textContent = mappings.length;
    document.getElementById('active-mappings').textContent = mappings.filter(m => m.is_active).length;
    document.getElementById('total-usage').textContent = mappings.reduce((sum, m) => sum + m.usage_count, 0);
}

function switchTab(tab) {
    currentTab = tab;
    localStorage.setItem('categories_tab', tab);
    const stats = document.getElementById('stats-section');
    const unmapped = document.getElementById('unmapped-section');
    const mappingsSec = document.getElementById('mappings-section');
    const categoriesSec = document.getElementById('categories-admin-section');
    const btnC = document.getElementById('tab-btn-categories');
    const btnM = document.getElementById('tab-btn-mappings');

    if (tab === 'categories') {
        if (stats) stats.style.display = 'none';
        if (unmapped) unmapped.style.display = 'none';
        if (mappingsSec) mappingsSec.style.display = 'none';
        if (categoriesSec) categoriesSec.style.display = 'block';
        if (btnC) btnC.classList.add('active');
        if (btnM) btnM.classList.remove('active');
    } else {
        if (stats) stats.style.display = 'grid';
        if (mappingsSec) mappingsSec.style.display = 'block';
        if (categoriesSec) categoriesSec.style.display = 'none';
        if (btnC) btnC.classList.remove('active');
        if (btnM) btnM.classList.add('active');
    }
}

function openCreateModal() {
    editingId = null;
    document.getElementById('modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ú–∞–ø–ø–∏–Ω–≥';
    document.getElementById('mapping-form').reset();
    document.getElementById('mapping-modal').style.display = 'flex';
}

function editMapping(id) {
    const mapping = mappings.find(m => m.id === id);
    if (!mapping) return;
    
    editingId = id;
    document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ú–∞–ø–ø–∏–Ω–≥';
    document.getElementById('ai-category').value = mapping.ai_category;
    document.getElementById('fixed-category').value = mapping.fixed_category;
    document.getElementById('confidence-threshold').value = mapping.confidence_threshold;
    document.getElementById('description').value = mapping.description || '';
    document.getElementById('mapping-modal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('mapping-modal').style.display = 'none';
    editingId = null;
}

document.getElementById('mapping-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        ai_category: formData.get('ai_category'),
        fixed_category: formData.get('fixed_category'),
        confidence_threshold: parseFloat(formData.get('confidence_threshold')),
        description: formData.get('description') || null
    };
    
    try {
        const url = editingId 
            ? `/api/v1/category-mappings/${editingId}` 
            : '/api/v1/category-mappings';
        const method = editingId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
        
        closeModal();
        await loadMappings();
        await loadUnmappedCategories(); // Refresh unmapped categories
        showAlert(editingId ? '–ú–∞–ø–ø–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ú–∞–ø–ø–∏–Ω–≥ —Å–æ–∑–¥–∞–Ω');
    } catch (error) {
        showAlert(error.message, 'error');
    }
});

async function toggleMapping(id) {
    try {
        const response = await fetch(`/api/v1/category-mappings/${id}/toggle`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è');
        }
        
        const result = await response.json();
        await loadMappings();
        await loadUnmappedCategories(); // Refresh unmapped categories
        showAlert(result.message);
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteMapping(id) {
    const mapping = mappings.find(m => m.id === id);
    if (!mapping) return;
    
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ "${mapping.ai_category}" ‚Üí "${mapping.fixed_category}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/category-mappings/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
        
        await loadMappings();
        await loadUnmappedCategories(); // Refresh unmapped categories
        showAlert('–ú–∞–ø–ø–∏–Ω–≥ —É–¥–∞–ª–µ–Ω');
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function toggleUnmappedSection() {
    const section = document.getElementById('unmapped-section');
    const button = document.getElementById('unmapped-toggle-btn');
    if (!section || !button) return;

    const hidden = (section.style.display === 'none' || !section.style.display);
    if (hidden) {
        section.style.display = 'block';
        button.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ';
        renderUnmappedCategories();
        // Scroll so the opened section is visible right after toggle button
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        section.style.display = 'none';
        button.textContent = `üîç –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ (${unmappedCategories.length})`;
    }
}

function renderUnmappedCategories() {
    const tbody = document.getElementById('unmapped-tbody');
    
    if (unmappedCategories.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                        <span style="font-size: 2rem;">‚úÖ</span>
                        <p style="margin: 0;">–í—Å–µ AI –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É–∂–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = unmappedCategories.map(item => `
        <tr>
            <td><strong style="color: var(--primary-color);">${item.ai_category}</strong></td>
            <td>
                <span class="badge badge-info" style="background: var(--surface-hover); color: var(--text-muted); padding: 0.25rem 0.5rem; border-radius: var(--border-radius-sm); font-size: 0.75rem;">
                    ${item.usage_count}
                </span>
            </td>
            <td>
                <span class="category-badge ${getCategoryBadgeClass(item.suggested_mapping)}">
                    ${item.suggested_mapping}
                </span>
            </td>
            <td>
                <button class="btn btn-small btn-success" onclick="createMappingFromSuggestion('${item.ai_category}', '${item.suggested_mapping}')" title="–°–æ–∑–¥–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–º">
                    ‚ûï –°–æ–∑–¥–∞—Ç—å
                </button>
            </td>
        </tr>
    `).join('');
}

function createMappingFromSuggestion(aiCategory, suggestedMapping) {
    // Pre-fill the modal with suggested data
    editingId = null;
    document.getElementById('modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ú–∞–ø–ø–∏–Ω–≥';
    document.getElementById('ai-category').value = aiCategory;
    document.getElementById('fixed-category').value = suggestedMapping;
    document.getElementById('confidence-threshold').value = '0.0';
    document.getElementById('description').value = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞`;
    document.getElementById('mapping-modal').style.display = 'flex';
}

// Close modal when clicking outside
document.getElementById('mapping-modal').addEventListener('click', function(event) {
    if (event.target === this) {
        closeModal();
    }
});

// Handle main category creation
const categoryForm = document.getElementById('category-form');
categoryForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
        name: document.getElementById('cat-name').value.trim(),
        display_name: document.getElementById('cat-display').value.trim(),
        color: document.getElementById('cat-color').value,
        description: document.getElementById('cat-desc').value.trim() || null,
    };

    try {
        const resp = await fetch('/api/v1/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        }
        await resp.json();
        showAlert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞');
        // Reset form
        categoryForm.reset();
        document.getElementById('cat-color').value = '#6c757d';
        // Refresh data
        await loadFixedCategories();
        await loadCategoriesList();
    } catch (error) {
        showAlert(error.message, 'error');
    }
});

// Edit Category Modal Functions
function openEditModal(name, displayName, color, description, id) {
    document.getElementById('edit-cat-id').value = id;
    document.getElementById('edit-cat-name').value = name;
    document.getElementById('edit-cat-display').value = displayName;
    document.getElementById('edit-cat-color').value = color;
    document.getElementById('edit-cat-desc').value = description;
    document.getElementById('edit-category-modal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('edit-category-modal').style.display = 'none';
}

// Edit Category Form Handler
document.getElementById('edit-category-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const categoryId = formData.get('category_id');
    const payload = {
        display_name: formData.get('display_name'),
        color: formData.get('color'),
        description: formData.get('description') || null
    };

    try {
        const resp = await fetch(`/api/v1/categories/${categoryId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.detail || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        }
        await resp.json();
        showAlert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        closeEditModal();
        // Refresh data
        await loadFixedCategories();
        await loadCategoriesList();
    } catch (error) {
        showAlert(error.message, 'error');
    }
});
</script>
        </div>
    </div>
{% endblock %}
