{% extends "base.html" %}

{% block title %}–ò—Å—Ç–æ—á–Ω–∏–∫–∏ - Evening News v2{% endblock %}

{% block content %}
<div class="admin-container">
    {% include "admin/_sidebar.html" %}

    <div class="admin-main">
        <div class="sources-header flex justify-between items-center mb-6">
            <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ RSS</h1>
            <button class="btn btn-primary" onclick="showAddSourceModal()" data-tooltip="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π RSS –∏—Å—Ç–æ—á–Ω–∏–∫">
                <span>‚ûï</span>
                <span>–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫</span>
            </button>
        </div>

        <div class="sources-stats-grid">
            <div class="stat-card" data-tooltip="–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ RSS –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤">
                <h3>–í—Å–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</h3>
                <div class="stat-number" id="total-sources">-</div>
                <div class="stat-label">–Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
            </div>

            <div class="stat-card" data-tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ</h3>
                <div class="stat-number" id="active-sources">-</div>
                <div class="stat-label">–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
            </div>

            <div class="stat-card" data-tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏">
                <h3>–û—à–∏–±–∫–∏</h3>
                <div class="stat-number" id="error-sources">-</div>
                <div class="stat-label">–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏</div>
            </div>

            <div class="stat-card" data-tooltip="–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏">
                <h3>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
                <div class="stat-number" id="last-sync" style="font-size: 1.25rem;">-</div>
                <div class="stat-label">–≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
            </div>
        </div>

        <div class="sources-filters flex gap-4 mb-6">
            <div class="filter-group">
                <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
                <select class="form-input" id="status-filter" onchange="filterSources()">
                    <option value="">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="error">–° –æ—à–∏–±–∫–∞–º–∏</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="form-label">–ü–æ–∏—Å–∫:</label>
                <input type="text" class="form-input" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ URL"
                    onkeyup="filterSources()">
            </div>

            <div class="filter-actions flex items-end">
                <button class="btn btn-ghost" onclick="refreshSources()" data-tooltip="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤">
                    <span>üîÑ</span>
                    <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                </button>
            </div>
        </div>

        <div class="table-container">
            <table class="table" id="sources-table">
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>URL</th>
                        <th>–¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</th>
                        <th>–°—Ç–∞—Ç—å–∏</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="sources-tbody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Source Modal -->
<div id="add-source-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ RSS</h2>
            <button class="modal-close" onclick="hideAddSourceModal()">&times;</button>
        </div>

        <form id="add-source-form" onsubmit="addSource(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="source-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞:</label>
                    <input type="text" id="source-name" class="form-input" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•–∞–±—Ä">
                </div>

                <div class="form-group">
                    <label class="form-label" for="source-url">URL RSS:</label>
                    <input type="url" id="source-url" class="form-input" required placeholder="https://example.com/rss">
                </div>

                <div class="form-group">
                    <label class="form-label" for="source-type">–¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞:</label>
                    <select id="source-type" class="form-input" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞</option>
                        <option value="rss">RSS-–∫–∞–Ω–∞–ª</option>
                        <option value="telegram">Telegram-–∫–∞–Ω–∞–ª</option>
                        <option value="reddit">Reddit</option>
                        <option value="twitter">Twitter</option>
                        <option value="news_api">News API</option>
                        <option value="custom">–ö–∞—Å—Ç–æ–º–Ω—ã–π –ø–∞—Ä—Å–µ—Ä</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="source-active">
                        <input type="checkbox" id="source-active" checked> –ê–∫—Ç–∏–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="hideAddSourceModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Source Modal -->
<div id="edit-source-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫</h2>
            <button class="modal-close" onclick="hideEditSourceModal()">&times;</button>
        </div>

        <form id="edit-source-form" onsubmit="updateSource(event)">
            <div class="modal-body">
                <input type="hidden" id="edit-source-id">

                <div class="form-group">
                    <label class="form-label" for="edit-source-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞:</label>
                    <input type="text" id="edit-source-name" class="form-input" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•–∞–±—Ä">
                </div>

                <div class="form-group">
                    <label class="form-label" for="edit-source-url">URL:</label>
                    <input type="url" id="edit-source-url" class="form-input" required
                        placeholder="https://example.com/rss">
                </div>

                <div class="form-group">
                    <label class="form-label" for="edit-source-type">–¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞:</label>
                    <select id="edit-source-type" class="form-input" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞</option>
                        <option value="rss">RSS-–∫–∞–Ω–∞–ª</option>
                        <option value="telegram">Telegram-–∫–∞–Ω–∞–ª</option>
                        <option value="reddit">Reddit</option>
                        <option value="twitter">Twitter</option>
                        <option value="news_api">News API</option>
                        <option value="custom">–ö–∞—Å—Ç–æ–º–Ω—ã–π –ø–∞—Ä—Å–µ—Ä</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="edit-source-active">
                        <input type="checkbox" id="edit-source-active"> –ê–∫—Ç–∏–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="hideEditSourceModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Source Modal -->
<div id="delete-source-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫?</h2>
            <button class="modal-close" onclick="hideDeleteSourceModal()">&times;</button>
        </div>

        <div class="modal-body">
            <input type="hidden" id="delete-source-id">
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ <strong id="delete-source-name-display"></strong>?</p>
            <p class="text-muted small">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>

            <div class="form-group mt-4">
                <label class="form-label text-danger" for="delete-source-articles">
                    <input type="checkbox" id="delete-source-articles">
                    –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –∏–∑ —ç—Ç–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                </label>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-ghost" onclick="hideDeleteSourceModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteSource()">–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞</button>
        </div>
    </div>
</div>

<style>
    /* Sources-specific styles */
    .sources-header {
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 1.5rem;
    }

    .sources-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }

    .sources-filters {
        background: var(--surface-hover);
        padding: 1.5rem;
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--border-color);
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-actions {
        gap: 0.5rem;
    }

    /* Enhanced table styling */
    .table tbody tr:hover {
        background: var(--surface-hover);
        cursor: pointer;
    }

    .table td {
        vertical-align: middle;
    }

    /* Action buttons in table */
    .table-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .btn-small {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        border-radius: 0.25rem;
        min-width: auto;
    }

    /* Modal styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .modal-content {
        background: var(--surface-color);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-xl);
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
        padding: 0.25rem;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        color: var(--text-color);
        background: var(--surface-hover);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    /* Status indicators */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Source type badges */
    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .badge-rss {
        background: var(--primary-color);
        color: white;
    }

    .badge-telegram {
        background: #0088cc;
        color: white;
    }

    .badge-reddit {
        background: #ff4500;
        color: white;
    }

    .badge-twitter {
        background: #1da1f2;
        color: white;
    }

    .badge-news_api {
        background: #6f42c1;
        color: white;
    }

    .badge-custom {
        background: var(--secondary-color);
        color: white;
    }

    .badge-other {
        background: var(--secondary-color);
        color: white;
    }

    .status-badge.status-active {
        background: var(--success-color);
        color: white;
    }

    .status-badge.status-inactive {
        background: var(--secondary-color);
        color: white;
    }

    .status-badge.status-error {
        background: var(--danger-color);
        color: white;
    }

    /* Loading state for table */
    .table-loading {
        opacity: 0.6;
        pointer-events: none;
    }

    /* Form enhancements */
    .form-group label[for*="active"] {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        cursor: pointer;
    }

    .form-group input[type="checkbox"] {
        width: auto;
        margin: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .sources-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .sources-filters {
            flex-direction: column;
            gap: 1rem;
        }

        .filter-actions {
            justify-content: stretch;
        }

        .filter-actions .btn {
            justify-content: center;
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            min-width: 600px;
        }

        .modal-content {
            margin: 1rem;
            max-width: none;
        }
    }
</style>

<script>
    let sourcesData = [];

    document.addEventListener('DOMContentLoaded', function () {
        loadSourcesData();
        loadSourcesStats();
    });

    async function loadSourcesData() {
        const tableBody = document.getElementById('sources-tbody');
        const table = document.getElementById('sources-table');

        try {
            table.classList.add('table-loading');

            const response = await NewsAggregator.apiRequest('/api/v1/sources');
            sourcesData = response.sources || [];

            displaySources(sourcesData);

        } catch (error) {
            console.error('Error loading sources:', error);
            tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center">
                    <p class="text-muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</p>
                </td>
            </tr>
        `;
            NewsAggregator.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤', 'error');
        } finally {
            table.classList.remove('table-loading');
        }
    }

    async function loadSourcesStats() {
        try {
            const response = await NewsAggregator.apiRequest('/api/v1/stats/dashboard');

            NewsAggregator.animateNumber(
                document.getElementById('total-sources'),
                response.total_sources || 0
            );

            NewsAggregator.animateNumber(
                document.getElementById('active-sources'),
                response.active_sources || 0
            );

            NewsAggregator.animateNumber(
                document.getElementById('error-sources'),
                0 // Error count not available in current API
            );

            const lastSyncEl = document.getElementById('last-sync');
            if (response.last_update) {
                const date = new Date(response.last_update);
                lastSyncEl.textContent = date.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else {
                lastSyncEl.textContent = '–ù–∏–∫–æ–≥–¥–∞';
            }

        } catch (error) {
            console.error('Error loading sources stats:', error);
        }
    }

    function displaySources(sources) {
        const tableBody = document.getElementById('sources-tbody');

        if (!sources || sources.length === 0) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center">
                    <p class="text-muted">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                </td>
            </tr>
        `;
            return;
        }

        const sourcesHtml = sources.map(source => `
        <tr data-source-id="${source.id}" onclick="editSource(${source.id})" style="cursor: pointer;" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
            <td>
                <strong>${source.name}</strong>
            </td>
            <td>
                <a href="${source.url}" target="_blank" class="text-primary" onclick="event.stopPropagation()">
                    ${truncateUrl(source.url)}
                </a>
            </td>
            <td>
                <span class="badge badge-${source.source_type || 'other'}">
                    ${getSourceTypeName(source.source_type)}
                </span>
            </td>
            <td>
                <span class="status-badge status-${source.is_active ? 'active' : 'inactive'}">
                    ${source.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                </span>
            </td>
            <td>
                ${source.last_updated ? formatDateTime(source.last_updated) : '–ù–∏–∫–æ–≥–¥–∞'}
            </td>
            <td>
                <span class="badge badge-info">${source.articles_count || 0}</span>
            </td>
            <td onclick="event.stopPropagation()">
                <div class="table-actions">
                    <button class="btn btn-small btn-primary" onclick="editSource(${source.id})" data-tooltip="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn btn-small ${source.is_active ? 'btn-warning' : 'btn-success'}" 
                            onclick="toggleSource(${source.id})" 
                            data-tooltip="${source.is_active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'} –∏—Å—Ç–æ—á–Ω–∏–∫">
                        ${source.is_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                    </button>
                    <button class="btn btn-small btn-danger" onclick="deleteSource(${source.id})" data-tooltip="–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫">
                        üóëÔ∏è
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

        tableBody.innerHTML = sourcesHtml;
    }

    function filterSources() {
        const statusFilter = document.getElementById('status-filter').value;
        const searchQuery = document.getElementById('search-input').value.toLowerCase();

        let filteredSources = sourcesData;

        // Filter by status
        if (statusFilter) {
            filteredSources = filteredSources.filter(source => {
                switch (statusFilter) {
                    case 'active':
                        return source.is_active;
                    case 'inactive':
                        return !source.is_active;
                    case 'error':
                        return source.has_errors;
                    default:
                        return true;
                }
            });
        }

        // Filter by search query
        if (searchQuery) {
            filteredSources = filteredSources.filter(source =>
                source.name.toLowerCase().includes(searchQuery) ||
                source.url.toLowerCase().includes(searchQuery)
            );
        }

        displaySources(filteredSources);
    }

    function showAddSourceModal() {
        document.getElementById('add-source-modal').style.display = 'flex';
        document.getElementById('source-name').focus();
    }

    function hideAddSourceModal() {
        document.getElementById('add-source-modal').style.display = 'none';
        document.getElementById('add-source-form').reset();
    }

    async function addSource(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        const sourceData = {
            name: document.getElementById('source-name').value,
            url: document.getElementById('source-url').value,
            source_type: document.getElementById('source-type').value,
            is_active: document.getElementById('source-active').checked
        };

        if (!NewsAggregator.validateForm(form)) {
            return;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.classList.add('btn-loading');
        submitButton.disabled = true;

        try {
            console.log('Sending source data:', sourceData);
            const response = await NewsAggregator.apiRequest('/api/v1/sources', {
                method: 'POST',
                body: JSON.stringify(sourceData)
            });

            if (response.id) {
                NewsAggregator.showNotification('–ò—Å—Ç–æ—á–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                hideAddSourceModal();
                loadSourcesData();
                loadSourcesStats();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
            }

        } catch (error) {
            console.error('Error adding source:', error);
            NewsAggregator.showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞: ' + error.message, 'error');
        } finally {
            submitButton.classList.remove('btn-loading');
            submitButton.disabled = false;
        }
    }

    async function testSource(sourceId) {
        try {
            const response = await NewsAggregator.apiRequest(`/api/v1/sources/${sourceId}/toggle`, {
                method: 'PATCH'
            });

            if (response.success) {
                NewsAggregator.showNotification(response.message, 'success');
                loadSourcesData();
                loadSourcesStats();
            } else {
                NewsAggregator.showNotification('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞', 'error');
            }

        } catch (error) {
            console.error('Error toggling source:', error);
            NewsAggregator.showNotification('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞', 'error');
        }
    }

    async function editSource(sourceId) {
        try {
            // Find source data in current sourcesData
            const source = sourcesData.find(s => s.id === sourceId);
            if (!source) {
                NewsAggregator.showNotification('–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            // Fill form with current data
            document.getElementById('edit-source-id').value = source.id;
            document.getElementById('edit-source-name').value = source.name;
            document.getElementById('edit-source-url').value = source.url;
            document.getElementById('edit-source-type').value = source.source_type;
            document.getElementById('edit-source-active').checked = source.is_active;

            // Show modal
            document.getElementById('edit-source-modal').style.display = 'flex';
            document.getElementById('edit-source-name').focus();

        } catch (error) {
            console.error('Error opening edit modal:', error);
            NewsAggregator.showNotification('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞', 'error');
        }
    }

    function hideEditSourceModal() {
        document.getElementById('edit-source-modal').style.display = 'none';
        document.getElementById('edit-source-form').reset();
    }

    async function updateSource(event) {
        event.preventDefault();

        const form = event.target;
        const sourceId = document.getElementById('edit-source-id').value;

        const sourceData = {
            name: document.getElementById('edit-source-name').value,
            url: document.getElementById('edit-source-url').value,
            source_type: document.getElementById('edit-source-type').value,
            is_active: document.getElementById('edit-source-active').checked
        };

        if (!NewsAggregator.validateForm(form)) {
            return;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.classList.add('btn-loading');
        submitButton.disabled = true;

        try {
            const response = await NewsAggregator.apiRequest(`/api/v1/sources/${sourceId}`, {
                method: 'PUT',
                body: JSON.stringify(sourceData)
            });

            if (response.success) {
                NewsAggregator.showNotification('–ò—Å—Ç–æ—á–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                hideEditSourceModal();
                loadSourcesData();
                loadSourcesStats();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
            }

        } catch (error) {
            console.error('Error updating source:', error);
            NewsAggregator.showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞: ' + error.message, 'error');
        } finally {
            submitButton.classList.remove('btn-loading');
            submitButton.disabled = false;
        }
    }

    async function deleteSource(sourceId) {
        const source = sourcesData.find(s => s.id === sourceId);
        if (!source) return;

        document.getElementById('delete-source-id').value = sourceId;
        document.getElementById('delete-source-name-display').textContent = source.name;
        document.getElementById('delete-source-articles').checked = false; // Default to unchecked

        document.getElementById('delete-source-modal').style.display = 'flex';
    }

    function hideDeleteSourceModal() {
        document.getElementById('delete-source-modal').style.display = 'none';
    }

    async function confirmDeleteSource() {
        const sourceId = document.getElementById('delete-source-id').value;
        const deleteArticles = document.getElementById('delete-source-articles').checked;
        const deleteBtn = document.querySelector('#delete-source-modal .btn-danger');

        try {
            deleteBtn.classList.add('btn-loading');
            deleteBtn.disabled = true;

            const url = `/api/v1/sources/${sourceId}${deleteArticles ? '?delete_articles=true' : ''}`;

            const response = await NewsAggregator.apiRequest(url, {
                method: 'DELETE'
            });

            if (response.success || response.message) {
                NewsAggregator.showNotification('–ò—Å—Ç–æ—á–Ω–∏–∫ —É–¥–∞–ª–µ–Ω', 'success');
                if (response.deleted_articles && response.deleted_articles > 0) {
                    NewsAggregator.showNotification(`–£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ç–µ–π: ${response.deleted_articles}`, 'info');
                }
                hideDeleteSourceModal();
                loadSourcesData();
                loadSourcesStats();
            } else {
                throw new Error(response.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
            }

        } catch (error) {
            console.error('Error deleting source:', error);
            NewsAggregator.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞: ' + (error.detail || error.message), 'error');
        } finally {
            deleteBtn.classList.remove('btn-loading');
            deleteBtn.disabled = false;
        }
    }

    function refreshSources() {
        loadSourcesData();
        loadSourcesStats();
        NewsAggregator.showNotification('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'info');
    }

    // Utility functions
    function truncateUrl(url, maxLength = 40) {
        return url.length > maxLength ? url.substring(0, maxLength) + '...' : url;
    }

    function getSourceTypeName(sourceType) {
        const sourceTypes = {
            'rss': 'RSS-–∫–∞–Ω–∞–ª',
            'telegram': 'Telegram',
            'reddit': 'Reddit',
            'twitter': 'Twitter',
            'news_api': 'News API',
            'custom': '–ö–∞—Å—Ç–æ–º–Ω—ã–π'
        };
        return sourceTypes[sourceType] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }

    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Close modal on escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            hideAddSourceModal();
            hideEditSourceModal();
        }
    });

    // Close modal on background click
    document.getElementById('add-source-modal').addEventListener('click', function (e) {
        if (e.target === this) {
            hideAddSourceModal();
        }
    });

    document.getElementById('edit-source-modal').addEventListener('click', function (e) {
        if (e.target === this) {
            hideEditSourceModal();
        }
    });
</script>
{% endblock %}