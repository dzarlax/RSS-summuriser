{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - Evening News v2{% endblock %}

{% block extra_css %}
<style>
.stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.stats-controls {
    display: flex;
    gap: 12px;
    align-items: center;
}

.stats-controls select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    background: white;
}

.refresh-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 500;
    transition: transform 0.2s ease;
}

.refresh-btn:hover {
    transform: translateY(-1px);
}

.refresh-btn.loading {
    opacity: 0.7;
    pointer-events: none;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.overview-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    position: relative;
    overflow: hidden;
}

.overview-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-primary);
}

.overview-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.overview-card-title {
    font-size: 14px;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.overview-card-icon {
    font-size: 24px;
    opacity: 0.7;
}

.overview-card-value {
    font-size: 32px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 8px;
}

.overview-card-label {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 12px;
}

.overview-card-trend {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 500;
}

.trend-up {
    color: #10b981;
}

.trend-down {
    color: #ef4444;
}

.trend-neutral {
    color: #6b7280;
}

.charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.chart-period {
    font-size: 12px;
    color: #6b7280;
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 4px;
}

.chart-canvas {
    position: relative;
    height: 300px;
}

.insights-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.insight-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.insight-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
}

.insight-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.insight-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
}

.insight-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.insight-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
}

.insight-item:last-child {
    border-bottom: none;
}

.insight-label {
    font-size: 14px;
    color: #4b5563;
}

.insight-value {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
}

.system-status {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    margin-top: 20px;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.status-healthy {
    background: #10b981;
}

.status-warning {
    background: #f59e0b;
}

.status-error {
    background: #ef4444;
}

.status-text {
    font-size: 14px;
    font-weight: 500;
    color: #374151;
}

/* AI Usage Section */
.ai-usage-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 20px;
}

.ai-usage-card {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    padding: 16px;
    border-radius: 10px;
    text-align: center;
}

.ai-usage-value {
    font-size: 24px;
    font-weight: 700;
    color: #92400e;
    margin-bottom: 4px;
}

.ai-usage-label {
    font-size: 12px;
    color: #b45309;
    font-weight: 500;
}

.ai-usage-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.ai-usage-details h4 {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 12px;
}

@media (max-width: 768px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }

    .insights-grid {
        grid-template-columns: 1fr;
    }

    .stats-header {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
    }

    .ai-usage-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .ai-usage-details {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock extra_css %}

{% block content %}
<div class="admin-container">
    {% include "admin/_sidebar.html" %}

    <div class="admin-main">
        <div class="stats-header">
            <h1>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
            <div class="stats-controls">
                <select id="periodSelect">
                    <option value="7d">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
                    <option value="30d" selected>–ó–∞ –º–µ—Å—è—Ü</option>
                    <option value="90d">–ó–∞ –∫–≤–∞—Ä—Ç–∞–ª</option>
                </select>
                <button class="refresh-btn" onclick="refreshStats()">
                    <span id="refresh-icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>
        
        <!-- Overview Cards -->
        <div class="stats-overview">
            <div class="overview-card">
                <div class="overview-card-header">
                    <div class="overview-card-title">–°—Ç–∞—Ç—å–∏ —Å–µ–≥–æ–¥–Ω—è</div>
                    <div class="overview-card-icon">üì∞</div>
                </div>
                <div class="overview-card-value" id="today-articles">0</div>
                <div class="overview-card-label">–Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π</div>
                <div class="overview-card-trend trend-neutral" id="articles-trend">
                    üìä –î–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
                </div>
            </div>
            
            <div class="overview-card">
                <div class="overview-card-header">
                    <div class="overview-card-title">AI –∑–∞–ø—Ä–æ—Å—ã</div>
                    <div class="overview-card-icon">ü§ñ</div>
                </div>
                <div class="overview-card-value" id="ai-requests">0</div>
                <div class="overview-card-label">–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ AI</div>
                <div class="overview-card-trend trend-neutral" id="ai-trend">
                    ü§ñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AI
                </div>
            </div>
            
            <div class="overview-card">
                <div class="overview-card-header">
                    <div class="overview-card-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</div>
                    <div class="overview-card-icon">üîó</div>
                </div>
                <div class="overview-card-value" id="active-sources">0</div>
                <div class="overview-card-label">—Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
                <div class="overview-card-trend trend-neutral" id="sources-trend">
                    üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏ RSS
                </div>
            </div>
            
            <div class="overview-card">
                <div class="overview-card-header">
                    <div class="overview-card-title">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
                    <div class="overview-card-icon">‚úÖ</div>
                </div>
                <div class="overview-card-value" id="success-rate">0%</div>
                <div class="overview-card-label">—É—Å–ø–µ—à–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫</div>
                <div class="overview-card-trend trend-neutral" id="success-trend">
                    ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç–µ–π</div>
                    <div class="chart-period" id="articles-period">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</div>
                </div>
                <div class="chart-canvas">
                    <canvas id="articlesChart"></canvas>
                    <div id="articlesChartFallback" style="display: none; padding: 60px; text-align: center; color: #6b7280;">
                        üìä –ì—Ä–∞—Ñ–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω<br>
                        <small>–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤...</small>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
                    <div class="chart-period">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div>
                </div>
                <div class="chart-canvas">
                    <canvas id="categoriesChart"></canvas>
                    <div id="categoriesChartFallback" style="display: none; padding: 60px; text-align: center; color: #6b7280;">
                        üç∞ –ì—Ä–∞—Ñ–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω<br>
                        <small>–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤...</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Insights -->
        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-header">
                    <div class="insight-icon" style="background: #ddd6fe; color: #7c3aed;">üèÜ</div>
                    <div class="insight-title">–¢–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∏</div>
                </div>
                <ul class="insight-list" id="top-sources">
                    <li class="insight-item">
                        <span class="insight-label">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        <span class="insight-value">-</span>
                    </li>
                </ul>
            </div>
            
            <div class="insight-card">
                <div class="insight-header">
                    <div class="insight-icon" style="background: #dcfce7; color: #16a34a;">‚ö°</div>
                    <div class="insight-title">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                </div>
                <ul class="insight-list" id="performance-metrics">
                    <li class="insight-item">
                        <span class="insight-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</span>
                        <span class="insight-value" id="avg-processing-time">-</span>
                    </li>
                    <li class="insight-item">
                        <span class="insight-label">–°—Ç–∞—Ç–µ–π –≤ —á–∞—Å</span>
                        <span class="insight-value" id="articles-per-hour">-</span>
                    </li>
                    <li class="insight-item">
                        <span class="insight-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AI</span>
                        <span class="insight-value" id="ai-usage">-</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- AI Usage Section -->
        <div class="insight-card" style="margin-top: 20px; grid-column: 1 / -1;">
            <div class="insight-header">
                <div class="insight-icon" style="background: #fef3c7; color: #d97706;">ü§ñ</div>
                <div class="insight-title">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AI —Ç–æ–∫–µ–Ω–æ–≤</div>
            </div>
            <div class="ai-usage-grid">
                <div class="ai-usage-card">
                    <div class="ai-usage-value" id="ai-tokens-today">0</div>
                    <div class="ai-usage-label">—Ç–æ–∫–µ–Ω–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="ai-usage-card">
                    <div class="ai-usage-value" id="ai-tokens-total">0</div>
                    <div class="ai-usage-label">—Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                </div>
                <div class="ai-usage-card">
                    <div class="ai-usage-value" id="ai-cost-total">$0.00</div>
                    <div class="ai-usage-label">—Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                </div>
                <div class="ai-usage-card">
                    <div class="ai-usage-value" id="ai-requests-total">0</div>
                    <div class="ai-usage-label">–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API</div>
                </div>
            </div>
            <div class="ai-usage-details">
                <div class="ai-usage-by-type">
                    <h4>–ü–æ —Ç–∏–ø—É –∞–Ω–∞–ª–∏–∑–∞</h4>
                    <ul class="insight-list" id="ai-by-type">
                        <li class="insight-item">
                            <span class="insight-label">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            <span class="insight-value">-</span>
                        </li>
                    </ul>
                </div>
                <div class="ai-usage-top-domains">
                    <h4>–¢–æ–ø –¥–æ–º–µ–Ω—ã –ø–æ —Ä–∞—Å—Ö–æ–¥—É</h4>
                    <ul class="insight-list" id="ai-top-domains">
                        <li class="insight-item">
                            <span class="insight-label">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            <span class="insight-value">-</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="system-status">
            <h3 style="margin-bottom: 16px; color: #1f2937;">üîß –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-indicator status-healthy" id="db-status"></div>
                    <div class="status-text">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-healthy" id="ai-status"></div>
                    <div class="status-text">AI —Å–µ—Ä–≤–∏—Å</div>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-healthy" id="rss-status"></div>
                    <div class="status-text">RSS –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</div>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-healthy" id="telegram-status"></div>
                    <div class="status-text">Telegram –±–æ—Ç</div>
                </div>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                <small style="color: #0369a1;">
                    üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <strong id="last-update-time">–∑–∞–≥—Ä—É–∑–∫–∞...</strong>
                </small>
            </div>
        </div>
    </div>
</div>

<script>
// Chart instances
let articlesChart = null;
let categoriesChart = null;
let lastDashboardData = null;
let lastAIUsageData = null;

// Function to wait for Chart.js to load
function waitForChart(callback, maxWait = 5000) {
    const startTime = Date.now();
    const checkChart = () => {
        console.log('Checking for Chart.js...', typeof Chart);
        if (typeof Chart !== 'undefined') {
            console.log('Chart.js found! Initializing...');
            callback();
        } else if (Date.now() - startTime < maxWait) {
            console.log('Chart.js not ready, retrying in 100ms...');
            setTimeout(checkChart, 100);
        } else {
            console.log('Chart.js failed to load within', maxWait, 'ms, showing fallbacks');
            showChartFallbacks();
            callback();
        }
    };
    checkChart();
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Stats Page');
    
    // Simple approach: wait a bit and then check for Chart.js
    setTimeout(function() {
        console.log('Checking for Chart.js after DOM load...');
        console.log('typeof Chart:', typeof Chart);
        
        if (typeof Chart !== 'undefined') {
            console.log('Chart.js is available! Initializing charts...');
            initializeApp(true);
        } else {
            console.log('Chart.js not available, showing fallbacks');
            initializeApp(false);
        }
    }, 100); // Short delay to ensure scripts load
});

function initializeApp(hasChart) {
    if (hasChart && typeof Chart !== 'undefined') {
        console.log('Chart.js is available! Initializing charts...');
        initializeCharts();
    } else {
        console.log('Chart.js not available, showing fallbacks');
        showChartFallbacks();
    }
    
    // Initialize app functionality
    console.log('Setting up app functionality...');
    
    // Period selector handler
    const periodSelect = document.getElementById('periodSelect');
    if (periodSelect) {
        periodSelect.addEventListener('change', function() {
            const period = this.value;
            console.log('Period changed to:', period);
            updateChartsForPeriod(period);
            loadStatistics();
        });
    }
    
    // Auto-refresh every 60 seconds
    setInterval(loadStatistics, 60000);
    
    // Load initial statistics
    loadStatistics();
}

function initializeCharts() {
    console.log('Initializing charts...');
    
    // Ensure canvas elements are visible
    const articlesCanvas = document.getElementById('articlesChart');
    const categoriesCanvas = document.getElementById('categoriesChart');
    
    if (articlesCanvas) {
        articlesCanvas.style.display = 'block';
        console.log('Articles canvas found and set to visible');
    } else {
        console.error('Articles canvas not found!');
        return;
    }
    
    if (categoriesCanvas) {
        categoriesCanvas.style.display = 'block';
        console.log('Categories canvas found and set to visible');
    } else {
        console.error('Categories canvas not found!');
        return;
    }
    
    // Hide fallback messages
    const articlesFallback = document.getElementById('articlesChartFallback');
    const categoriesFallback = document.getElementById('categoriesChartFallback');
    
    if (articlesFallback) articlesFallback.style.display = 'none';
    if (categoriesFallback) categoriesFallback.style.display = 'none';
    
    // Articles processing chart
    console.log('Creating articles chart...');
    const articlesCtx = articlesCanvas.getContext('2d');
    articlesChart = new Chart(articlesCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '–°—Ç–∞—Ç—å–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }, {
                label: 'AI –æ–±—Ä–∞–±–æ—Ç–∫–∏',
                data: [],
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointBackgroundColor: '#8b5cf6',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    cornerRadius: 8,
                    displayColors: true
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#6b7280',
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: '#6b7280',
                        font: {
                            size: 11
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });

    // Categories distribution chart
    console.log('Creating categories chart...');
    const categoriesCtx = categoriesCanvas.getContext('2d');
    categoriesChart = new Chart(categoriesCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#3b82f6', '#8b5cf6', '#06d6a0', 
                    '#f59e0b', '#ef4444', '#6366f1',
                    '#10b981', '#f97316', '#ec4899'
                ],
                borderWidth: 0,
                hoverBorderWidth: 2,
                hoverBorderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
    
    console.log('Charts initialized successfully!');
}

async function loadStatistics() {
    try {
        const refreshBtn = document.querySelector('.refresh-btn');
        const refreshIcon = document.getElementById('refresh-icon');
        
        // Show loading state
        refreshBtn.classList.add('loading');
        refreshIcon.textContent = '‚è≥';
        
        // Load dashboard stats
        const dashboardResponse = await fetch('/api/v1/stats/dashboard');
        if (dashboardResponse.ok) {
            const dashboard = await dashboardResponse.json();
            lastDashboardData = dashboard;
            updateOverviewCards(dashboard);
        }
        
        // Load chart data
        await loadChartData();
        
        // Load insights
        await loadInsights();

        // Load AI usage stats
        await loadAIUsageStats();

        // Update performance metrics with latest data
        updatePerformanceMetrics();

        // Update system status
        updateSystemStatus(true);
        
        // Update last update time
        document.getElementById('last-update-time').textContent = 
            new Date().toLocaleString('ru-RU');
        
    } catch (error) {
        console.error('Error loading statistics:', error);
        showErrorState();
        updateSystemStatus(false);
    } finally {
        // Reset loading state
        const refreshBtn = document.querySelector('.refresh-btn');
        const refreshIcon = document.getElementById('refresh-icon');
        refreshBtn.classList.remove('loading');
        refreshIcon.textContent = 'üîÑ';
    }
}

function updateOverviewCards(data) {
    // Update overview cards with real data
    document.getElementById('today-articles').textContent = data.today_articles || '0';
    document.getElementById('ai-requests').textContent = data.api_calls_today || '0';
    document.getElementById('active-sources').textContent = data.active_sources || '0';
    
    // Calculate success rate based on real data
    let successRate = 0;
    if (typeof data.api_success_rate === 'number') {
        successRate = data.api_success_rate;
    } else if (data.api_calls_today) {
        const errorsToday = data.errors_today || 0;
        successRate = Math.round(((data.api_calls_today - errorsToday) / data.api_calls_today) * 100);
    }
    document.getElementById('success-rate').textContent = `${successRate}%`;
    
    // Update trend descriptions based on actual data
    updateTrendDescriptions(data);
}

function updateTrendDescriptions(data) {
    // Update trend descriptions to be informative rather than misleading
    const articlesCount = data.today_articles || 0;
    const articlesTrend = document.getElementById('articles-trend');
    
    if (articlesCount === 0) {
        articlesTrend.textContent = 'üìä –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π';
        articlesTrend.className = 'overview-card-trend trend-neutral';
    } else if (articlesCount < 10) {
        articlesTrend.textContent = 'üìä –ù–µ–±–æ–ª—å—à–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å';
        articlesTrend.className = 'overview-card-trend trend-neutral';
    } else if (articlesCount >= 10 && articlesCount < 50) {
        articlesTrend.textContent = 'üìà –£–º–µ—Ä–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å';
        articlesTrend.className = 'overview-card-trend trend-up';
    } else {
        articlesTrend.textContent = 'üìà –í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å';
        articlesTrend.className = 'overview-card-trend trend-up';
    }
    
    // AI requests trend
    const aiRequests = data.api_calls_today || 0;
    const aiTrend = document.getElementById('ai-trend');
    
    if (aiRequests === 0) {
        aiTrend.textContent = 'ü§ñ AI –≤ –æ–∂–∏–¥–∞–Ω–∏–∏';
    } else {
        aiTrend.textContent = `ü§ñ ${aiRequests} –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ AI`;
    }
    
    // Sources status
    const activeSourcesCount = data.active_sources || 0;
    const totalSourcesCount = data.total_sources || 0;
    const sourcesTrend = document.getElementById('sources-trend');
    
    if (totalSourcesCount === 0) {
        sourcesTrend.textContent = 'üîó –ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤';
    } else if (activeSourcesCount === totalSourcesCount) {
        sourcesTrend.textContent = 'üîó –í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã';
        sourcesTrend.className = 'overview-card-trend trend-up';
    } else if (activeSourcesCount > 0) {
        sourcesTrend.textContent = `üîó ${activeSourcesCount} –∏–∑ ${totalSourcesCount} –∞–∫—Ç–∏–≤–Ω—ã`;
        sourcesTrend.className = 'overview-card-trend trend-neutral';
    } else {
        sourcesTrend.textContent = 'üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã';
        sourcesTrend.className = 'overview-card-trend trend-down';
    }
}

async function loadChartData() {
    console.log('Loading chart data...');
    console.log('Chart available:', typeof Chart !== 'undefined');
    console.log('Articles chart:', !!articlesChart);
    console.log('Categories chart:', !!categoriesChart);
    
    // Skip if Chart.js not available
    if (typeof Chart === 'undefined' || !articlesChart || !categoriesChart) {
        console.log('Charts not initialized, skipping chart data update');
        return;
    }
    
    const period = document.getElementById('periodSelect').value;
    const days = period === '7d' ? 7 : period === '30d' ? 30 : 90;

    // Articles chart data (real API)
    try {
        const processingResponse = await fetch(`/api/v1/stats/processing?days=${days}`);
        if (processingResponse.ok) {
            const processingData = await processingResponse.json();
            const dailyStats = processingData.daily_stats || [];

            const labels = [];
            const articles = [];
            const aiRequests = [];

            dailyStats.forEach(stat => {
                const date = stat.date ? new Date(stat.date) : null;
                labels.push(formatDateLabel(date, days));
                articles.push(stat.articles_processed || 0);
                aiRequests.push(stat.api_calls_made || 0);
            });

            articlesChart.data.labels = labels;
            articlesChart.data.datasets[0].data = articles;
            articlesChart.data.datasets[1].data = aiRequests;
            articlesChart.update('none');
        }
    } catch (error) {
        console.error('Error loading processing stats:', error);
    }
    
    // Categories chart data
    try {
        const categoriesResponse = await fetch('/api/v1/summaries/categories');
        if (categoriesResponse.ok) {
            const categories = await categoriesResponse.json();
            updateCategoriesChart(categories);
        } else {
            // Fallback mock data
            updateCategoriesChart({
                categories: [
                    { name: 'Tech', count: 45 },
                    { name: 'Business', count: 32 },
                    { name: 'Science', count: 28 },
                    { name: 'Other', count: 15 }
                ]
            });
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function formatDateLabel(date, days) {
    if (!date || Number.isNaN(date.getTime())) {
        return '';
    }
    if (days <= 7) {
        return date.toLocaleDateString('ru-RU', { weekday: 'short' });
    }
    if (days <= 30) {
        return date.toLocaleDateString('ru-RU', { day: 'numeric' });
    }
    return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
}

function updateCategoriesChart(data) {
    if (!categoriesChart || typeof Chart === 'undefined') {
        console.log('Categories chart not available');
        return;
    }
    
    if (data.categories && data.categories.length > 0) {
        categoriesChart.data.labels = data.categories.map(cat => cat.category || cat.name);
        categoriesChart.data.datasets[0].data = data.categories.map(cat => cat.summaries_count || cat.count || cat.articles_count);
        categoriesChart.update('none');
    }
}

async function loadInsights() {
    // Load top sources
    try {
        const sourcesResponse = await fetch('/api/v1/sources');
        if (sourcesResponse.ok) {
            const sourcesData = await sourcesResponse.json();
            const sources = sourcesData.sources || [];
            const topSources = sources
                .sort((a, b) => (b.articles_count || 0) - (a.articles_count || 0))
                .slice(0, 5)
                .map(source => ({
                    name: source.name || source.url,
                    articles: source.articles_count || 0
                }));
            updateTopSources({ top_sources: topSources });
        } else {
            updateTopSources({ top_sources: [] });
        }
    } catch (error) {
        console.error('Error loading sources insight:', error);
        updateTopSources({ top_sources: [] });
    }
}

function updateTopSources(data) {
    const container = document.getElementById('top-sources');
    if (data.top_sources && data.top_sources.length > 0) {
        container.innerHTML = data.top_sources.map(source => `
            <li class="insight-item">
                <span class="insight-label">${source.name}</span>
                <span class="insight-value">${source.articles} —Å—Ç–∞—Ç–µ–π</span>
            </li>
        `).join('');
    } else {
        container.innerHTML = `
            <li class="insight-item">
                <span class="insight-label">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                <span class="insight-value">-</span>
            </li>
        `;
    }
}

function updatePerformanceMetrics() {
    const avgEl = document.getElementById('avg-processing-time');
    const perHourEl = document.getElementById('articles-per-hour');
    const aiUsageEl = document.getElementById('ai-usage');

    const dashboard = lastDashboardData || {};
    const aiUsage = lastAIUsageData || {};

    const avgMs = dashboard.avg_processing_time || 0;
    avgEl.textContent = avgMs > 0 ? `${(avgMs / 1000).toFixed(1)} sec` : '-';

    const perHour = dashboard.articles_per_hour || 0;
    perHourEl.textContent = perHour.toString();

    const todayTokens = aiUsage.today?.tokens || 0;
    const totalTokens = aiUsage.total?.tokens || 0;
    const percent = totalTokens > 0 ? Math.round((todayTokens / totalTokens) * 100) : 0;
    aiUsageEl.textContent = `${percent}%`;
}

async function loadAIUsageStats() {
    try {
        const period = document.getElementById('periodSelect').value;
        const days = period === '7d' ? 7 : period === '30d' ? 30 : 90;

        const response = await fetch(`/api/v1/stats/ai-usage?days=${days}`);
        if (!response.ok) {
            throw new Error('Failed to load AI usage stats');
        }

        const data = await response.json();
        lastAIUsageData = data;

        // Update main stats
        document.getElementById('ai-tokens-today').textContent = formatNumber(data.today?.tokens || 0);
        document.getElementById('ai-tokens-total').textContent = formatNumber(data.total?.tokens || 0);
        document.getElementById('ai-cost-total').textContent = `$${(data.total?.cost || 0).toFixed(6)}`;
        document.getElementById('ai-requests-total').textContent = formatNumber(data.total?.requests || 0);

        // Update by type list
        const byTypeContainer = document.getElementById('ai-by-type');
        if (data.by_type && data.by_type.length > 0) {
            byTypeContainer.innerHTML = data.by_type.map(item => `
                <li class="insight-item">
                    <span class="insight-label">${formatAnalysisType(item.type)}</span>
                    <span class="insight-value">${formatNumber(item.tokens)} —Ç–æ–∫–µ–Ω–æ–≤</span>
                </li>
            `).join('');
        } else {
            byTypeContainer.innerHTML = `
                <li class="insight-item">
                    <span class="insight-label">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                    <span class="insight-value">-</span>
                </li>
            `;
        }

        // Update top domains list
        const topDomainsContainer = document.getElementById('ai-top-domains');
        if (data.top_domains && data.top_domains.length > 0) {
            topDomainsContainer.innerHTML = data.top_domains.slice(0, 5).map(item => `
                <li class="insight-item">
                    <span class="insight-label">${item.domain}</span>
                    <span class="insight-value">${formatNumber(item.tokens)} —Ç–æ–∫–µ–Ω–æ–≤</span>
                </li>
            `).join('');
        } else {
            topDomainsContainer.innerHTML = `
                <li class="insight-item">
                    <span class="insight-label">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                    <span class="insight-value">-</span>
                </li>
            `;
        }

    } catch (error) {
        console.error('Error loading AI usage stats:', error);
        lastAIUsageData = null;
        // Show error state
        document.getElementById('ai-tokens-today').textContent = '-';
        document.getElementById('ai-tokens-total').textContent = '-';
        document.getElementById('ai-cost-total').textContent = '-';
        document.getElementById('ai-requests-total').textContent = '-';
    }
}

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

function formatAnalysisType(type) {
    const typeNames = {
        'selector_discovery': '–ü–æ–∏—Å–∫ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤',
        'pattern_analysis': '–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤',
        'dom_structure': '–ê–Ω–∞–ª–∏–∑ DOM',
        'summarization': '–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è',
        'categorization': '–ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è',
        'combined_analysis': '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑'
    };
    return typeNames[type] || type;
}

function updateSystemStatus(isHealthy) {
    const services = ['db-status', 'ai-status', 'rss-status', 'telegram-status'];
    const status = isHealthy ? 'healthy' : 'warning';
    services.forEach(service => {
        const element = document.getElementById(service);
        if (element) {
            element.className = `status-indicator status-${status}`;
        }
    });
}

function updateChartsForPeriod(period) {
    const periodLabels = {
        '7d': '–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π',
        '30d': '–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π', 
        '90d': '–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π'
    };
    
    document.getElementById('articles-period').textContent = periodLabels[period];
}

function refreshStats() {
    loadStatistics();
}

function showChartFallbacks() {
    // Hide canvas elements and show fallback messages
    document.getElementById('articlesChart').style.display = 'none';
    document.getElementById('articlesChartFallback').style.display = 'block';
    document.getElementById('categoriesChart').style.display = 'none';
    document.getElementById('categoriesChartFallback').style.display = 'block';
}

function showErrorState() {
    const elements = [
        'today-articles', 'ai-requests', 'active-sources', 'success-rate'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = '‚ö†Ô∏è';
        }
    });
    
    // Update status indicators to show error
    const statusElements = ['db-status', 'ai-status', 'rss-status', 'telegram-status'];
    statusElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.className = 'status-indicator status-error';
        }
    });
}
</script>

<script src="/static/js/chart.min.js"></script>
<script>
console.log('=== BOTTOM SCRIPT EXECUTING ===');
console.log('Chart.js should be loaded from script tag above');
console.log('typeof Chart:', typeof Chart);
</script>
{% endblock %}
