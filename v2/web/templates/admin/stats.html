{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - RSS Summarizer v2{% endblock %}

{% block head %}
<style>
.stats-sections {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.stats-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stats-section h2 {
    margin: 0 0 20px 0;
    color: var(--primary-color);
}

.performance-metrics {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.performance-metrics p {
    margin: 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-sidebar">
        <h3>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <nav class="admin-nav">
            <a href="/admin" class="nav-item">
                <span class="icon">üìä</span> –î–∞—à–±–æ—Ä–¥
            </a>
            <a href="/admin/sources" class="nav-item">
                <span class="icon">üì∞</span> –ò—Å—Ç–æ—á–Ω–∏–∫–∏
            </a>
            <a href="/admin/stats" class="nav-item active">
                <span class="icon">üìà</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </a>
            <a href="/admin/backup" class="nav-item">
                <span class="icon">üíæ</span> –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
            </a>
        </nav>
    </div>

    <div class="admin-main">
        <h1>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h1>
        
        <div class="stats-sections">
            <div class="stats-section">
                <h2>–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>–°–µ–≥–æ–¥–Ω—è</h3>
                        <div class="stat-number" id="today-articles">-</div>
                        <div class="stat-label">—Å—Ç–∞—Ç–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ó–∞ –Ω–µ–¥–µ–ª—é</h3>
                        <div class="stat-number" id="week-articles">-</div>
                        <div class="stat-label">—Å—Ç–∞—Ç–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ</h3>
                        <div class="stat-number" id="total-articles">-</div>
                        <div class="stat-label">—Å—Ç–∞—Ç–µ–π –≤ –±–∞–∑–µ</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section">
                <h2>API –≤—ã–∑–æ–≤—ã</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>–°–µ–≥–æ–¥–Ω—è</h3>
                        <div class="stat-number" id="today-api-calls">-</div>
                        <div class="stat-label">–≤—ã–∑–æ–≤–æ–≤ AI API</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                        <div class="stat-number" id="total-categories">-</div>
                        <div class="stat-label">–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section">
                <h2>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ</h3>
                        <div class="stat-number" id="active-sources">-</div>
                        <div class="stat-label">—Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ</h3>
                        <div class="stat-number" id="total-sources">-</div>
                        <div class="stat-label">–Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section">
                <h2>–°–∏—Å—Ç–µ–º–∞</h2>
                <div class="performance-metrics">
                    <p>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <strong id="last-update">-</strong></p>
                    <p>–°—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: <strong>‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∞</strong></p>
                    <p>–°—Ç–∞—Ç—É—Å Redis: <strong>‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load real statistics
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    
    // Auto-refresh every 30 seconds
    setInterval(loadStatistics, 30000);
});

async function loadStatistics() {
    try {
        // Load dashboard stats
        const dashboardResponse = await fetch('/api/v1/stats/dashboard');
        if (dashboardResponse.ok) {
            const dashboard = await dashboardResponse.json();
            
            document.getElementById('today-articles').textContent = dashboard.today_articles || '0';
            document.getElementById('total-categories').textContent = dashboard.categories_count || '0';
            document.getElementById('today-api-calls').textContent = dashboard.api_calls_today || '0';
            document.getElementById('active-sources').textContent = dashboard.active_sources || '0';
            document.getElementById('total-sources').textContent = dashboard.total_sources || '0';
            document.getElementById('last-update').textContent = dashboard.last_update ? 
                formatDateTime(dashboard.last_update) : '–ù–∏–∫–æ–≥–¥–∞';
        }
        
        // Load additional stats
        await loadAdditionalStats();
        
    } catch (error) {
        console.error('Error loading statistics:', error);
        showErrorState();
    }
}

async function loadAdditionalStats() {
    try {
        // Get total articles count
        const articlesResponse = await fetch('/api/v1/feed?limit=1');
        if (articlesResponse.ok) {
            const articles = await articlesResponse.json(); 
            // This is approximate - we'd need a proper endpoint for total count
            document.getElementById('total-articles').textContent = '20+';
        }
        
        // Get week articles (mock for now)
        document.getElementById('week-articles').textContent = '20';
        
    } catch (error) {
        console.error('Error loading additional stats:', error);
    }
}

function formatDateTime(dateString) {
    if (!dateString) return '–ù–∏–∫–æ–≥–¥–∞';
    const date = new Date(dateString);
    return date.toLocaleString('ru-RU');
}

function showErrorState() {
    const elements = [
        'today-articles', 'week-articles', 'total-articles',
        'today-api-calls', 'total-categories', 'active-sources', 
        'total-sources', 'last-update'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = '‚ö†Ô∏è';
        }
    });
}
</script>
{% endblock %}