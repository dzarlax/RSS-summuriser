{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="admin-container">
    {% include "admin/_sidebar.html" %}

    <div class="admin-main">
        <h1>–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</h1>
        
        <!-- Quick Actions -->
        <div class="backup-actions">
            <button class="btn btn-primary" onclick="createBackup()">
                <span class="icon">üíæ</span> –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
            </button>
            <button class="btn btn-success" onclick="showUploadModal()">
                <span class="icon">üìÅ</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å backup
            </button>
            <button class="btn btn-secondary" onclick="refreshBackups()">
                <span class="icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
            </button>
        </div>

        <!-- Backup Status -->
        <div class="status-panel" id="backup-status" style="display: none;">
            <h3>–°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
            <div class="status-content">
                <div class="status-indicator" id="status-indicator"></div>
                <div class="status-message" id="status-message">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
                <div class="status-progress" id="status-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Settings -->
        <div class="backup-schedule">
            <h2>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</h2>
            <div class="schedule-form">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="schedule-enabled"> 
                        –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
                    </label>
                </div>
                <div class="form-group">
                    <label for="schedule-time">–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è (UTC):</label>
                    <input type="time" id="schedule-time" value="03:00">
                </div>
                <div class="form-group">
                    <label for="keep-days">–•—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ (–¥–Ω–µ–π):</label>
                    <input type="number" id="keep-days" value="30" min="1" max="365">
                </div>
                <button class="btn btn-primary" onclick="saveSchedule()">
                    <span class="icon">üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
        </div>

        <!-- Backups List -->
        <div class="backups-section">
            <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</h2>
            <div class="backups-table-container">
                <table class="backups-table">
                    <thead>
                        <tr>
                            <th>–§–∞–π–ª</th>
                            <th>–†–∞–∑–º–µ—Ä</th>
                            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="backups-list">
                        <tr>
                            <td colspan="4" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Restore Confirmation Modal -->
<div id="restore-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ö†Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏</h3>
            <span class="close" onclick="hideRestoreModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p><strong>–í–ù–ò–ú–ê–ù–ò–ï!</strong> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ:</p>
            <ul>
                <li>–í—Å–µ —Å—Ç–∞—Ç—å–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</li>
                <li>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</li>
                <li>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞</li>
            </ul>
            <p>–§–∞–π–ª –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: <span id="restore-filename"></span></p>
            <p><strong>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</strong></p>
            
            <div class="confirmation-input">
                <label for="restore-confirmation">
                    –í–≤–µ–¥–∏—Ç–µ "RESTORE" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
                </label>
                <input type="text" id="restore-confirmation" placeholder="RESTORE">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideRestoreModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-danger" onclick="confirmRestore()" id="confirm-restore-btn" disabled>
                –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<!-- Upload Backup Modal -->
<div id="upload-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å Backup –§–∞–π–ª</h3>
            <span class="close" onclick="hideUploadModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ backup —Ñ–∞–π–ª (.tar.gz) –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:</p>
            
            <div class="upload-area">
                <input type="file" id="backup-file-input" accept=".tar.gz" style="display: none;">
                <div class="file-drop-zone" onclick="document.getElementById('backup-file-input').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">
                        <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                        <p><small>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .tar.gz —Ñ–∞–π–ª—ã</small></p>
                    </div>
                </div>
                <div id="selected-file-info" style="display: none;">
                    <p>–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª: <span id="selected-filename"></span></p>
                    <p>–†–∞–∑–º–µ—Ä: <span id="selected-filesize"></span></p>
                </div>
            </div>
            
            <div id="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="upload-progress-fill"></div>
                </div>
                <p id="upload-status">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideUploadModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-success" onclick="uploadSelectedFile()" id="upload-btn" disabled>
                –ó–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<style>
.backup-actions {
    margin-bottom: 30px;
    display: flex;
    gap: 15px;
}

.status-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
}

.status-content {
    display: flex;
    align-items: center;
    gap: 15px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #28a745;
    animation: pulse 2s infinite;
}

.status-indicator.running {
    background: #ffc107;
}

.status-indicator.error {
    background: #dc3545;
    animation: none;
}

.progress-bar {
    width: 200px;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #007bff;
    width: 0%;
    animation: progress 3s infinite;
}

.backup-schedule {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 30px;
}

.schedule-form {
    display: grid;
    gap: 20px;
    max-width: 500px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-group input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.backups-section {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 25px;
}

.backups-table-container {
    overflow-x: auto;
}

.backups-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.backups-table th,
.backups-table td {
    text-align: left;
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}

.backups-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.backup-actions-cell {
    display: flex;
    gap: 8px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.875rem;
}

.btn-danger {
    background: #dc3545;
    color: white;
    border: 1px solid #dc3545;
}

.btn-danger:hover {
    background: #c82333;
    border-color: #bd2130;
}

.btn-primary {
    background: #007bff;
    color: white;
    border: 1px solid #007bff;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.btn-primary:hover {
    background: #0056b3;
    border-color: #004085;
    color: white;
    text-decoration: none;
}

.backup-actions-cell {
    display: flex;
    gap: 8px;
    align-items: center;
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.confirmation-input {
    margin-top: 20px;
}

.confirmation-input input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-top: 5px;
}

.upload-area {
    margin: 20px 0;
}

.file-drop-zone {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.3s;
}

.file-drop-zone:hover {
    border-color: #007bff;
}

.upload-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

.upload-text p {
    margin: 5px 0;
    color: #666;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-fill {
    height: 100%;
    background-color: #28a745;
    width: 0%;
    transition: width 0.3s;
}

.loading {
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

@keyframes progress {
    0% { width: 0%; }
    50% { width: 70%; }
    100% { width: 100%; }
}
</style>

<script>
let currentBackups = [];
let restoreBackupFile = '';

// Load page data
document.addEventListener('DOMContentLoaded', function() {
    loadBackups();
    loadScheduleSettings();
});

// Backup operations
async function createBackup() {
    showStatus('running', '–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...');
    
    try {
        const response = await fetch('/api/v1/backup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                description: 'Manual backup from web interface'
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showStatus('success', '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ');
            setTimeout(() => {
                loadBackups();
                hideStatus();
            }, 5000);
        } else {
            showStatus('error', `–û—à–∏–±–∫–∞: ${result.detail || result.message}`);
        }
    } catch (error) {
        showStatus('error', `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: ${error.message}`);
    }
}

async function loadBackups() {
    try {
        const response = await fetch('/api/v1/backups');
        const data = await response.json();
        
        currentBackups = data.backups || [];
        displayBackups(currentBackups);
    } catch (error) {
        console.error('Error loading backups:', error);
        displayBackups([]);
    }
}

function displayBackups(backups) {
    const tbody = document.getElementById('backups-list');
    
    if (backups.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="loading">–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
        return;
    }
    
    tbody.innerHTML = backups.map(backup => `
        <tr>
            <td>
                <strong>${backup.filename}</strong>
                <br>
                <small class="text-muted">${backup.filepath}</small>
            </td>
            <td>${backup.size_mb} MB</td>
            <td>
                ${new Date(backup.created_at).toLocaleString('ru-RU')}
            </td>
            <td>
                <div class="backup-actions-cell">
                    <a href="/api/v1/backup/download/${backup.filename}" 
                       class="btn btn-sm btn-primary" 
                       download="${backup.filename}"
                       title="–°–∫–∞—á–∞—Ç—å backup —Ñ–∞–π–ª">
                        <span class="icon">‚¨áÔ∏è</span> –°–∫–∞—á–∞—Ç—å
                    </a>
                    <button class="btn btn-sm btn-danger" onclick="showRestoreModal('${backup.filepath}', '${backup.filename}')">
                        <span class="icon">üîÑ</span> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function refreshBackups() {
    showStatus('running', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π...');
    loadBackups();
    setTimeout(() => hideStatus(), 2000);
}

// Restore operations
function showRestoreModal(filepath, filename) {
    restoreBackupFile = filepath;
    document.getElementById('restore-filename').textContent = filename;
    document.getElementById('restore-confirmation').value = '';
    document.getElementById('confirm-restore-btn').disabled = true;
    document.getElementById('restore-modal').style.display = 'flex';
}

function hideRestoreModal() {
    document.getElementById('restore-modal').style.display = 'none';
    restoreBackupFile = '';
}

function confirmRestore() {
    const confirmation = document.getElementById('restore-confirmation').value;
    
    if (confirmation !== 'RESTORE') {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ "RESTORE" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
        return;
    }
    
    hideRestoreModal();
    performRestore();
}

async function performRestore() {
    showStatus('running', '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...');
    
    try {
        const response = await fetch('/api/v1/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                backup_file: restoreBackupFile
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showStatus('success', '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ. –°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω...');
            setTimeout(() => {
                window.location.reload();
            }, 10000);
        } else {
            showStatus('error', `–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${result.detail || result.message}`);
        }
    } catch (error) {
        showStatus('error', `–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}`);
    }
}

// Schedule operations
async function loadScheduleSettings() {
    try {
        const response = await fetch('/api/v1/backup/schedule');
        const settings = await response.json();
        
        document.getElementById('schedule-enabled').checked = settings.enabled || false;
        document.getElementById('schedule-time').value = settings.schedule_time || '03:00';
        document.getElementById('keep-days').value = settings.keep_days || 30;
    } catch (error) {
        console.error('Error loading schedule settings:', error);
    }
}

async function saveSchedule() {
    const enabled = document.getElementById('schedule-enabled').checked;
    const scheduleTime = document.getElementById('schedule-time').value;
    const keepDays = parseInt(document.getElementById('keep-days').value);
    
    try {
        const response = await fetch('/api/v1/backup/schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                enabled: enabled,
                schedule_time: scheduleTime,
                keep_days: keepDays
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showStatus('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            setTimeout(() => hideStatus(), 3000);
        } else {
            showStatus('error', `–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${result.detail || result.message}`);
        }
    } catch (error) {
        showStatus('error', `–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${error.message}`);
    }
}

// Status management
function showStatus(type, message) {
    const statusPanel = document.getElementById('backup-status');
    const indicator = document.getElementById('status-indicator');
    const messageEl = document.getElementById('status-message');
    const progress = document.getElementById('status-progress');
    
    statusPanel.style.display = 'block';
    messageEl.textContent = message;
    
    // Reset indicator classes
    indicator.className = 'status-indicator';
    
    if (type === 'running') {
        indicator.classList.add('running');
        progress.style.display = 'block';
    } else if (type === 'error') {
        indicator.classList.add('error');
        progress.style.display = 'none';
    } else if (type === 'success') {
        progress.style.display = 'none';
    }
}

function hideStatus() {
    document.getElementById('backup-status').style.display = 'none';
}

// Enable/disable restore button based on confirmation
document.getElementById('restore-confirmation').addEventListener('input', function(e) {
    const btn = document.getElementById('confirm-restore-btn');
    btn.disabled = e.target.value !== 'RESTORE';
});

// Upload Modal Functions
function showUploadModal() {
    document.getElementById('upload-modal').style.display = 'flex';
}

function hideUploadModal() {
    document.getElementById('upload-modal').style.display = 'none';
    // Reset form
    document.getElementById('backup-file-input').value = '';
    document.getElementById('selected-file-info').style.display = 'none';
    document.getElementById('upload-progress').style.display = 'none';
    document.getElementById('upload-btn').disabled = true;
}

// File selection handler
document.getElementById('backup-file-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById('selected-filename').textContent = file.name;
        document.getElementById('selected-filesize').textContent = formatFileSize(file.size);
        document.getElementById('selected-file-info').style.display = 'block';
        document.getElementById('upload-btn').disabled = false;
    }
});

async function uploadSelectedFile() {
    const fileInput = document.getElementById('backup-file-input');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        return;
    }
    
    if (!file.name.endsWith('.tar.gz')) {
        alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .tar.gz —Ñ–∞–π–ª—ã');
        return;
    }
    
    // Show progress
    document.getElementById('upload-progress').style.display = 'block';
    document.getElementById('upload-btn').disabled = true;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const xhr = new XMLHttpRequest();
        
        // Progress handler
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                document.getElementById('upload-progress-fill').style.width = percentComplete + '%';
                document.getElementById('upload-status').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞... ${Math.round(percentComplete)}%`;
            }
        });
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                document.getElementById('upload-status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                
                // Show success and ask for restore
                setTimeout(() => {
                    hideUploadModal();
                    if (confirm(`–§–∞–π–ª ${response.filename} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç—Ç–æ–≥–æ backup?`)) {
                        restoreFromUploadedBackup(response.filename);
                    } else {
                        refreshBackups(); // Just refresh the list
                    }
                }, 1000);
            } else {
                throw new Error(`Upload failed: ${xhr.status}`);
            }
        };
        
        xhr.onerror = function() {
            document.getElementById('upload-status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            document.getElementById('upload-btn').disabled = false;
        };
        
        xhr.open('POST', '/api/v1/backup/upload');
        xhr.send(formData);
        
    } catch (error) {
        console.error('Upload error:', error);
        document.getElementById('upload-status').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
        document.getElementById('upload-btn').disabled = false;
    }
}

async function restoreFromUploadedBackup(filename) {
    try {
        const response = await fetch('/api/v1/restore/upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ filename: filename })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus('success', `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ ${filename} –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ñ–æ–Ω–µ`);
        } else {
            showStatus('error', `–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${result.message}`);
        }
    } catch (error) {
        console.error('Restore error:', error);
        showStatus('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{% endblock %} 
