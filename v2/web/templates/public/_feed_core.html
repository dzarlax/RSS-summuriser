<script>
// Unified feed core: shared state, fetching, rendering, pagination
(function(){
  // View mode: 'cards' | 'list'
  const VIEW = (window.FEED_VIEW === 'list') ? 'list' : 'cards';

  // Elements
  const listEl = document.getElementById('news-list');
  const feedEl = document.getElementById('news-feed');
  const container = listEl || feedEl;
  // Ensure sentinel exists
  let sentinel = document.getElementById('feed-sentinel');
  if (!sentinel) {
    sentinel = document.createElement('div');
    sentinel.id = 'feed-sentinel';
    sentinel.style.height = '1px';
    container?.parentElement?.appendChild(sentinel);
  }

  // State
  let currentPage = 0;
  let isLoading = false;
  let hasMore = true;
  let currentCategory = 'all';
  let selectedCategories = [];
  let allCategories = {};

  // View prefs (make global for toolbar access)
  window.hideAds = true;
  let hideAds = window.hideAds;
  let currentSinceHours = null;
  let renderedImageCount = 0;
  let isWide = true;

  // Category UI config (will be loaded from API)
  let categoryConfig = {
    'all': { name: '–í—Å–µ', color: '#17a2b8' },
    'other': { name: '–†–∞–∑–Ω–æ–µ', color: '#6c757d' }
  };

  // Helpers
  function escapeHtml(text){ if(!text) return ''; const d=document.createElement('div'); d.textContent=text; return d.innerHTML; }
  function formatDate(s){ if(!s) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; const d=new Date(s); const now=new Date(); const dh=Math.floor((now-d)/36e5); if(dh<1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ'; if(dh<24) return dh+' —á. –Ω–∞–∑–∞–¥'; const dd=Math.floor(dh/24); if(dd<7) return dd+' –¥–Ω. –Ω–∞–∑–∞–¥'; return d.toLocaleDateString('ru-RU'); }
  
  function isLightColor(hexColor) {
    // Convert hex to RGB
    const hex = hexColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    
    // Calculate relative luminance using WCAG formula
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    
    // Return true if light (luminance > 0.5)
    return luminance > 0.5;
  }
  
  // Simple image extraction for fallback (when backend doesn't provide images)
  
  function extractImageFromContent(content){ 
    if(!content) return ''; 
    // Simple fallback image extraction from text
    const m=String(content).match(/https?:[^\s"']+\.(jpg|jpeg|png|webp)/i); 
    return m?m[0]:''; 
  }
  
  function cleanHtmlSummary(html){ if(!html) return ''; let s=String(html); s=s.replace(/<script[\s\S]*?<\/script>/gi,''); s=s.replace(/<style[\s\S]*?<\/style>/gi,''); s=s.replace(/<[^>]+>/g,' '); s=s.replace(/&nbsp;/g,' '); s=s.replace(/\s+/g,' ').trim(); return s; }

  function applyWideClass(){ const root=document.querySelector('.news-page'); if(!root) return; root.classList.add('wide'); }

  function updateURLState(){ const p=new URLSearchParams(); if(selectedCategories.length>0) p.set('category', selectedCategories.join(',')); else if(currentCategory && currentCategory!=='all') p.set('category', currentCategory); if(currentSinceHours) p.set('since', String(currentSinceHours)); p.set('ads', hideAds?'off':'on'); const qs=p.toString(); history.replaceState(null,'', qs?`?${qs}`:location.pathname); }
  function updateSinceControls(){ document.querySelectorAll('.since-btn').forEach(b=>{ const v=parseInt(b.getAttribute('data-since')); b.setAttribute('aria-pressed', String(v===currentSinceHours)); }); }
  function syncQuickToggles(){ const m=(id,on)=>{const b=document.getElementById(id); if(!b) return; b.setAttribute('aria-pressed', String(!!on)); b.classList.toggle('active', !!on);}; m('qt-hide-ads', hideAds); /* wide removed control */ }

  function containerHtmlFor(article){
    const categories = article.categories || [];
    const primary = categories.length? categories[0] : null;
    const legacy = (article.category||'Other').toLowerCase();
    const category = (primary? primary.name.toLowerCase() : legacy);
    const categoryInfo = categoryConfig[category]||categoryConfig['other']||{name:category};
    
    // Use images from backend API (no need to extract on frontend)
    const img = article.primary_image || article.image_url || extractImageFromContent(article.summary || '');
    const summary = cleanHtmlSummary(article.summary||'');
    const highPrio = (currentPage===0 && renderedImageCount<3);
    const categoriesBadges = categories.slice(0,3).map(c=>{
      const categoryKey = c.name.toLowerCase();
      const config = categoryConfig[categoryKey] || {name: c.display_name || c.name, color: c.color || '#6c757d'};
      const bgColor = c.color || config.color || '#6c757d';
      const textColor = isLightColor(bgColor) ? '#000000' : '#ffffff';
      return `<div class="category-badge" style="background: ${bgColor}; color: ${textColor}; border: 1px solid ${bgColor};">${escapeHtml(c.display_name||c.name)}</div>`;
    }).join('');
    const ad = article.is_advertisement ? `<div class="ad-badge" title="–†–µ–∫–ª–∞–º–∞">üö® –†–ï–ö–õ–ê–ú–ê</div>` : '';
    if (VIEW==='list') {
      const imgBlock = img? `<div class="news-list-image"><img src="${img}" alt="${escapeHtml(article.title)}" loading="lazy" ${highPrio?'fetchpriority="high"':''} decoding="async"></div>`: '';
      const actionsBlock = `<div class="news-list-actions"><button class="btn-read-more" onclick="openArticleModal(${article.id})">üìñ –ß–∏—Ç–∞—Ç—å –±–æ–ª—å—à–µ</button><a href="${article.url}" target="_blank" rel="noopener" class="btn-original">üîó –û—Ä–∏–≥–∏–Ω–∞–ª</a></div>`;
      return `<article class="news-list-item" data-category="${category}">${imgBlock}<div class="news-list-content"><div class="news-list-badges">${categoriesBadges}${ad}</div><h2 class="news-list-title" onclick="openArticleModal(${article.id})" style="cursor: pointer;">${escapeHtml(article.title)}</h2>${summary?`<p class="news-list-summary">${escapeHtml(summary)}</p>`:''}<div class="news-list-meta"><span class="news-list-source">${escapeHtml(article.source_name||'')}</span><span class="news-list-date">${formatDate(article.published_at)}</span></div>${actionsBlock}</div></article>`;
    }
    const imgBlock = img? `<div class="news-image"><img src="${img}" alt="${escapeHtml(article.title)}" loading="lazy" ${highPrio?'fetchpriority="high"':''} decoding="async">${ad}</div>`: '';
    const actionsBlock = `<div class="news-actions"><button class="btn-read-more" onclick="openArticleModal(${article.id})">üìñ –ß–∏—Ç–∞—Ç—å –±–æ–ª—å—à–µ</button><a href="${article.url}" target="_blank" rel="noopener" class="btn-original">üîó –û—Ä–∏–≥–∏–Ω–∞–ª</a></div>`;
    return `<article class="news-item" data-category="${category}">${imgBlock}<div class="news-content"><div class="news-feed-badges">${categoriesBadges}</div><h2 class="news-title" onclick="openArticleModal(${article.id})" style="cursor: pointer;">${escapeHtml(article.title)}</h2>${summary?`<p class="news-summary">${escapeHtml(summary)}</p>`:''}<div class="news-meta"><span class="news-source">${escapeHtml(article.source_name||'')}</span><span class="news-date">${formatDate(article.published_at)}</span></div></div>${actionsBlock}</article>`;
  }

  // Load category configuration from API (with caching)
  let categoryConfigLoaded = false;
  async function loadCategoryConfig() {
    if (categoryConfigLoaded) return; // Already loaded
    
    try {
      const response = await fetch('/api/public/categories/config');
      if (response.ok) {
        const data = await response.json();
        categoryConfig = { ...categoryConfig, ...data.categories };
        categoryConfigLoaded = true;
        console.log('‚úÖ Loaded category config from API:', Object.keys(categoryConfig));
      }
    } catch (error) {
      console.error('Error loading category config:', error);
    }
  }

  async function loadCategories(){
    try{
      // Ensure category config is loaded first
      await loadCategoryConfig();
      
      const params=new URLSearchParams(); if(currentSinceHours) params.set('since_hours',String(currentSinceHours)); params.set('hide_ads', hideAds?'true':'false');
      const r=await fetch(`/api/public/categories?${params.toString()}`); if(!r.ok) throw new Error('categories');
      const data=await r.json(); allCategories=data.categories||{all:0};
      updateAllCategoryFilters(); renderCategorySelectors();
    }catch(e){ allCategories={all:0}; updateAllCategoryFilters(); renderCategorySelectors(); }
  }

  // Top chips renderer (optional). In current UI it's hidden; keep graceful implementation.
  function updateAllCategoryFilters(){
    const filterButtons = document.getElementById('filter-buttons');
    if (!filterButtons) return; // nothing to render
    // If container is present (e.g., future designs), render compact set
    let html = '';
    const total = allCategories.all || 0;
    html += `<button class="filter-btn ${currentCategory==='all' && selectedCategories.length===0 ? 'active':''}" data-category="all" onclick="selectSingleCategory('all')" aria-pressed="${currentCategory==='all'}" title="–í—Å–µ"><span>–í—Å–µ</span><span class="count">${total}</span></button>`;
    Object.keys(allCategories).filter(k=>k!=='all').sort((a,b)=>(allCategories[b]||0)-(allCategories[a]||0)).slice(0,12).forEach(cat=>{
      const cfg = categoryConfig[cat] || {name: cat.charAt(0).toUpperCase()+cat.slice(1)};
      html += `<button class="filter-btn ${currentCategory===cat ? 'active':''}" data-category="${cat}" onclick="selectSingleCategory('${cat}')" aria-pressed="${currentCategory===cat}" title="${cfg.name}"><span>${cfg.name}</span><span class="count">${allCategories[cat]||0}</span></button>`;
    });
    filterButtons.innerHTML = html;
  }

  async function loadNews(reset=false){ if(isLoading) return; isLoading=true; if(reset){ currentPage=0; renderedImageCount=0; hasMore=true; if(container){ container.innerHTML=`<div class="loading-state"><div class="loading-spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</p></div>`; } }
    try{
      const limit=20, offset=currentPage*limit; let url=`/api/public/feed?limit=${limit}&offset=${offset}&hide_ads=${hideAds?'true':'false'}`; if(currentSinceHours) url+=`&since_hours=${currentSinceHours}`; if(selectedCategories.length>0) url+=`&category=${encodeURIComponent(selectedCategories.join(','))}`; else if(currentCategory && currentCategory!=='all') url+=`&category=${encodeURIComponent(currentCategory)}`;
      const r=await fetch(url); if(!r.ok) throw new Error('feed'); const data=await r.json(); let articles=data.articles||[];
      const html = articles.map(a=>{ const h=containerHtmlFor(a); if((a.primary_image||a.image_url)) renderedImageCount++; return h; }).join('');
      if (reset) container.innerHTML=html; else container.insertAdjacentHTML('beforeend', html);
      const loadMoreBtn=document.getElementById('load-more-container'); hasMore = (articles.length===limit); if(loadMoreBtn) loadMoreBtn.style.display = hasMore?'block':'none'; currentPage++;
    }catch(e){
      if(reset && container){ container.innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><h3>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–µ–Ω—Ç—É</h3></div>`; }
    }finally{ isLoading=false; }
  }

  // Sidebar & sheet
  function renderCategorySelectors(){
    const build=(id,mobile)=>{ const el=document.getElementById(id); if(!el) return; const entries=Object.entries(allCategories).filter(([n])=>n!=='all').sort((a,b)=>(b[1]||0)-(a[1]||0)); const allCount=allCategories.all||0; let html=''; if(mobile){ html+=`<div class="cat-sheet-item ${ (selectedCategories.length===0 && currentCategory==='all') ? 'active':'' }" onclick="selectSingleCategory('all'); closeCatSheet();"><span>–í—Å–µ</span><span class="count">${allCount}</span></div>`; } else { html+=`<div class="sidebar-item sidebar-item-all ${ (selectedCategories.length===0 && currentCategory==='all') ? 'active':'' }" onclick="selectSingleCategory('all')"><span>–í—Å–µ</span><span class="sidebar-count">${allCount}</span></div>`; }
      html+=entries.map(([name,count])=>{ const display=(categoryConfig[name]?.name)||(name.charAt(0).toUpperCase()+name.slice(1)); const active = selectedCategories.length>0? selectedCategories.includes(name) : (currentCategory===name); if(mobile){ return `<div class="cat-sheet-item ${active?'active':''}" onclick="selectSingleCategory('${name}'); closeCatSheet();"><span>${escapeHtml(display)}</span><span class="count">${count}</span></div>`; } return `<div class="sidebar-item ${active?'active':''}" onclick="selectSingleCategory('${name}')"><span>${escapeHtml(display)}</span><span class="sidebar-count">${count}</span></div>`; }).join(''); el.innerHTML=html; };
    build('cat-list', false); build('cat-list-mobile', true);
  }
  window.selectSingleCategory = function(name){ 
    selectedCategories=[]; 
    currentCategory=name; 
    updateURLState(); 
    // Ensure config is loaded before rendering
    loadCategoryConfig().then(() => renderCategorySelectors()); 
    loadNews(true); 
  };
  window.openCatSheet = function(){ const s=document.getElementById('cat-sheet'); if(s) s.setAttribute('aria-hidden','false'); };
  window.closeCatSheet = function(){ const s=document.getElementById('cat-sheet'); if(s) s.setAttribute('aria-hidden','true'); };

  // Toolbar actions exposed
  window.setSinceHours = function(h){ currentSinceHours=h; localStorage.setItem('view_since_hours', h?String(h):''); updateSinceControls(); updateURLState(); loadNews(true); loadCategories(); };
  window.toggleHideAds = function(v){ hideAds=!!v; window.hideAds=hideAds; updateURLState(); loadNews(true); loadCategories(); syncQuickToggles(); };

  // Init
  document.addEventListener('DOMContentLoaded',()=>{
    // Parse URL state
    try{ const p=new URLSearchParams(location.search); const qCat=p.get('category'); const qSince=p.get('since'); const qAds=p.get('ads'); if(qCat){ const cats=qCat.split(',').map(s=>s.trim()).filter(Boolean); if(cats.length>1){ selectedCategories=cats; currentCategory='all'; } else currentCategory=cats[0].toLowerCase(); } if(qSince) currentSinceHours=parseInt(qSince,10)||null; if(qAds) hideAds=(qAds!=='on'); window.hideAds=hideAds; }catch{}
    applyWideClass(); updateSinceControls(); syncQuickToggles(); 
    // Load categories (which loads config first) and news
    loadCategories(); 
    loadNews(true);
    // Infinite scroll
    try{ const io=new IntersectionObserver(([e])=>{ if(e.isIntersecting && hasMore) loadNews(false); }, {rootMargin:'600px 0px'}); const s=document.getElementById('feed-sentinel'); if(s) io.observe(s); }catch{}
  }, {once:true});

  // Expose manual load more for the fallback button
  window.loadMoreNews = function(){ loadNews(false); };

  // Modal functions are now in _article_modal.html

})();
</script>
